<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switzea - Dato Sync FIXED</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f5f7fa;
            overflow-x: hidden;
            user-select: none;
        }
        
        .fix-banner {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            text-align: center;
            padding: 15px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .header .project-info { font-size: 0.9rem; opacity: 0.9; }
        .header .empty-project { font-style: italic; opacity: 0.7; }
        
        .header-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            font-family: inherit;
            position: relative;
        }
        
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-outline { background: transparent; color: white; border: 1px solid white; }
        .btn-danger { background: #f44336; color: white; }
        
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { 
            opacity: 0.4; 
            cursor: not-allowed; 
            transform: none; 
            background: #666 !important;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 160px);
        }
        
        .sidebar {
            width: 250px;
            background: white;
            border-right: 2px solid #e0e0e0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        .sidebar h3 {
            margin-bottom: 1rem;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.2rem;
        }
        
        .craftsman-list {
            list-style: none;
            flex: 1;
        }
        
        .empty-craftsmen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
            font-style: italic;
        }
        
        .empty-craftsmen p {
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .craftsman-item {
            padding: 1rem;
            margin: 0.5rem 0;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            border-left: 6px solid;
            cursor: grab;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .craftsman-item:hover { 
            background: linear-gradient(145deg, #e9ecef, #dee2e6);
            transform: translateX(5px) scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .delete-craftsman {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .delete-craftsman:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .timeline-container {
            flex: 1;
            padding: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .week-controls {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .timeline-grid {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .empty-timeline {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #666;
            font-style: italic;
        }
        
        .grid-header {
            display: flex;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-bottom: 3px solid #dee2e6;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            min-height: 70px;
        }
        
        .header-craftsman {
            min-width: 200px;
            max-width: 200px;
            padding: 1rem;
            border-right: 3px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #e9ecef, #d6d8db);
            font-size: 1.1rem;
            color: #495057;
            font-weight: 600;
        }
        
        .header-days {
            flex: 1;
            display: flex;
        }
        
        .week-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #dee2e6;
        }
        
        .week-section:last-child {
            border-right: none;
        }
        
        .week-header {
            padding: 0.4rem;
            background: linear-gradient(145deg, #d6d8db, #c6c8ca);
            border-bottom: 1px solid #dee2e6;
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
            line-height: 1.2;
        }
        
        .days-row {
            display: flex;
            flex: 1;
        }
        
        .day-header {
            flex: 1;
            padding: 0.5rem 0.25rem;
            border-right: 1px solid #dee2e6;
            text-align: center;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 0.7rem;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            line-height: 1.1;
        }
        
        .day-header:last-child { border-right: none; }
        .day-header.today { background: linear-gradient(145deg, #e3f2fd, #bbdefb); color: #1976d2; font-weight: bold; }
        
        .grid-body {
            flex: 1;
            overflow-y: auto;
        }
        
        .grid-row {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            min-height: 80px;
            position: relative;
        }
        
        .grid-row:nth-child(even) { background: #fafbfc; }
        
        .row-craftsman {
            min-width: 200px;
            max-width: 200px;
            padding: 1rem;
            border-right: 3px solid #dee2e6;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 6px solid;
            position: sticky;
            left: 0;
            z-index: 5;
            box-shadow: 2px 0 3px rgba(0,0,0,0.1);
        }
        
        .craftsman-name {
            flex: 1;
        }
        
        .remove-craftsman-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .row-craftsman:hover .remove-craftsman-btn {
            opacity: 1;
        }
        
        .row-days {
            flex: 1;
            display: flex;
            position: relative;
        }
        
        .grid-cell {
            flex: 1;
            border-right: 1px solid #dee2e6;
            position: relative;
            transition: all 0.2s;
            min-height: 80px;
        }
        
        .grid-cell:last-child { border-right: none; }
        .grid-cell:hover { background: #e3f2fd; }
        .grid-cell.drop-zone { 
            background: #c8e6c9 !important; 
            border: 2px dashed #4CAF50 !important;
            transform: scale(1.02);
        }
        
        .grid-cell.today {
            background: #e8f5e8;
            border-left: 3px solid #4CAF50;
        }
        
        .task {
            position: absolute;
            background: linear-gradient(145deg, #2196F3, #1976D2);
            color: white;
            border-radius: 6px;
            padding: 0.4rem;
            cursor: move;
            font-size: 0.75rem;
            line-height: 1.1;
            z-index: 3;
            transition: all 0.2s;
            border: 2px solid transparent;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            top: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .task:hover:not(.dragging) {
            transform: scale(1.03) translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 4;
        }
        
        .task.dragging {
            opacity: 0.7;
            transform: rotate(5deg) scale(1.05);
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .task.high { 
            border-left: 6px solid #f44336; 
            background: linear-gradient(145deg, #e53935, #c62828);
        }
        .task.medium { 
            border-left: 6px solid #ff9800; 
            background: linear-gradient(145deg, #fb8c00, #ef6c00);
        }
        .task.low { 
            border-left: 6px solid #4caf50; 
            background: linear-gradient(145deg, #43a047, #388e3c);
        }
        
        .task.planned { background: linear-gradient(145deg, #6c757d, #5a6268); }
        .task.in-progress { background: linear-gradient(145deg, #2196F3, #1976D2); }
        .task.completed { background: linear-gradient(145deg, #4CAF50, #388E3C); }
        
        .task.half-day {
            height: 40px !important;
            font-size: 0.7rem;
            padding: 0.25rem;
        }
        
        .task-title {
            font-weight: bold;
            font-size: 0.75rem;
            pointer-events: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            margin-bottom: 0.2rem;
        }
        
        .task-controls {
            display: flex;
            gap: 0.25rem;
            margin-top: auto;
        }
        
        .task-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.65rem;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            z-index: 10;
        }
        
        .task-btn:hover { 
            background: rgba(255,255,255,0.4);
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 520px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.2s;
        }
        
        .modal.show .modal-content { transform: scale(1); }
        
        .modal h3 {
            margin-bottom: 1.5rem;
            color: #333;
            font-size: 1.3rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
        }
        
        .form-row .form-group { flex: 1; }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }
        
        /* FIXED: Datepicker styling */
        .datepicker-wrapper {
            position: relative;
        }
        
        .datepicker-input {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23666" viewBox="0 0 16 16"><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/></svg>') no-repeat right 10px center;
            padding-right: 40px;
            border-color: #4CAF50 !important;
        }
        
        .custom-datepicker {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            padding: 20px;
        }
        
        .custom-datepicker.show {
            display: block;
        }
        
        .datepicker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .datepicker-nav {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .datepicker-nav:hover {
            background: #45a049;
        }
        
        .datepicker-title {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }
        
        .year-month-selectors {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .year-month-selectors select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .datepicker-calendar {
            width: 100%;
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 5px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-weight: bold;
            color: #666;
            font-size: 0.8rem;
            padding: 5px;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background: #e3f2fd;
        }
        
        .calendar-day.other-month {
            color: #ccc;
        }
        
        .calendar-day.selected {
            background: #4CAF50;
            color: white;
        }
        
        .calendar-day.today {
            background: #f0f8ff;
            border: 2px solid #2196F3;
            font-weight: bold;
        }
        
        /* FIXED: Timeline position indicator */
        .task-position-indicator {
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
            animation: bounce 0.5s;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
        
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 500;
            max-width: 300px;
        }
        
        .toast.show { transform: translateX(0); }
        .toast.error { background: #f44336; }
        .toast.warning { background: #ff9800; }
        .toast.info { background: #2196F3; }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
                max-height: 200px;
                overflow-y: auto;
            }
            
            .header-craftsman, .row-craftsman {
                min-width: 120px;
                max-width: 120px;
            }
            
            .task {
                height: 50px;
                font-size: 0.7rem;
            }
            
            .week-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="fix-banner">
        üîß SWITZEA DATO-SYNC FIXED - Test: V√¶lg ny dato ‚Üí Se opgave flytte automatisk til korrekt dag!
    </div>

    <header class="header">
        <div class="header-left">
            <h1 id="projectTitle">Capellas All√© 38 - Test</h1>
            <div class="project-info" id="projectInfo">
                <span class="empty-project">FIXED VERSION - Test dato sync nu!</span>
            </div>
        </div>
        <div class="header-buttons">
            <button class="btn btn-primary" onclick="testDateSync()">üß™ Test Dato Sync</button>
            <button class="btn btn-secondary" onclick="resetTestData()">üîÑ Reset Test Data</button>
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <h3>
                H√•ndv√¶rkere 
                <button class="btn btn-primary" onclick="openCraftsmanModal()">+ Tilf√∏j</button>
            </h3>
            <ul class="craftsman-list" id="craftsmanList">
                <div class="empty-craftsmen">
                    <p>Ingen h√•ndv√¶rkere tilf√∏jet endnu</p>
                    <button class="btn btn-primary" onclick="openCraftsmanModal()">Tilf√∏j f√∏rste h√•ndv√¶rker</button>
                </div>
            </ul>
        </div>

        <div class="timeline-container">
            <div class="week-controls">
                <button class="btn btn-secondary" onclick="removeWeek()">‚àí Fjern uge</button>
                <span id="weekDisplay">3 uger</span>
                <button class="btn btn-secondary" onclick="addWeek()">+ Tilf√∏j uge</button>
                <div style="font-weight: 600; color: #333;">Projekt: 16/09/2025 - 04/10/2025</div>
            </div>
            
            <div class="timeline-grid" id="timelineGrid">
                <div class="empty-timeline">
                    <p>Tilf√∏j h√•ndv√¶rkere for at se tidslinjen</p>
                </div>
            </div>
        </div>
    </div>

    <!-- FIXED Task Modal with REAL-TIME date sync -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h3 id="modalTitle">Ny opgave</h3>
            
            <div class="form-group">
                <label for="taskTitle">Opgavetitel</label>
                <input type="text" class="form-control" id="taskTitle">
            </div>
            
            <div class="form-group">
                <label for="taskDescription">Beskrivelse</label>
                <textarea class="form-control" id="taskDescription" rows="3"></textarea>
            </div>
            
            <!-- KRITISK FIX: Startdato med REAL-TIME sync -->
            <div class="form-group">
                <label for="taskStartDate">üìÖ Startdato (synkroniserer automatisk med timeline)</label>
                <div class="datepicker-wrapper">
                    <input type="text" class="form-control datepicker-input" id="taskStartDate" placeholder="V√¶lg startdato..." readonly>
                    <div class="custom-datepicker" id="customDatepicker">
                        <div class="datepicker-header">
                            <button type="button" class="datepicker-nav" id="prevMonth">‚Äπ</button>
                            <div class="datepicker-title" id="datepickerTitle">September 2025</div>
                            <button type="button" class="datepicker-nav" id="nextMonth">‚Ä∫</button>
                        </div>
                        
                        <div class="year-month-selectors">
                            <select id="yearSelector">
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                            <select id="monthSelector">
                                <option value="0">Januar</option>
                                <option value="1">Februar</option>
                                <option value="2">Marts</option>
                                <option value="3">April</option>
                                <option value="4">Maj</option>
                                <option value="5">Juni</option>
                                <option value="6">Juli</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">Oktober</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                        </div>
                        
                        <div class="datepicker-calendar">
                            <div class="calendar-weekdays">
                                <div class="calendar-weekday">Ma</div>
                                <div class="calendar-weekday">Ti</div>
                                <div class="calendar-weekday">On</div>
                                <div class="calendar-weekday">To</div>
                                <div class="calendar-weekday">Fr</div>
                                <div class="calendar-weekday">L√∏</div>
                                <div class="calendar-weekday">S√∏</div>
                            </div>
                            <div class="calendar-days" id="calendarDays">
                                <!-- Days will be generated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- REAL-TIME position indicator -->
                <div id="positionIndicator" style="display: none;">
                    <div class="task-position-indicator">
                        Opgaven vil blive placeret p√•: <span id="calculatedPosition"></span>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="taskNotes">Noter/Kommentarer</label>
                <textarea class="form-control" id="taskNotes" rows="2" placeholder="Tilf√∏j noter om fremgang, problemer, materialer..."></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="taskCraftsman">H√•ndv√¶rker</label>
                    <select class="form-control" id="taskCraftsman">
                        <option value="">V√¶lg h√•ndv√¶rker...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskPriority">Prioritet</label>
                    <select class="form-control" id="taskPriority">
                        <option value="low">Lav</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">H√∏j</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="taskStatus">Status</label>
                    <select class="form-control" id="taskStatus">
                        <option value="planned" selected>Planlagt</option>
                        <option value="in-progress">I gang</option>
                        <option value="completed">Udf√∏rt</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskDuration">Varighed (dage)</label>
                    <input type="number" class="form-control" id="taskDuration" min="0.5" step="0.5" value="1">
                </div>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="taskHalfDay">
                    <label for="taskHalfDay">Halv dag opgave</label>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-danger" id="deleteTaskBtn" style="display: none;" onclick="deleteCurrentTask()">Slet opgave</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">Annull√©r</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">Gem opgave</button>
            </div>
        </div>
    </div>

    <!-- Add Craftsman Modal -->
    <div class="modal" id="craftsmanModal">
        <div class="modal-content">
            <h3>Tilf√∏j h√•ndv√¶rker</h3>
            
            <div class="form-group">
                <label for="craftsmanType">H√•ndv√¶rkertype</label>
                <select class="form-control" id="craftsmanType">
                    <option value="">V√¶lg type...</option>
                    <option value="Projektleder">Projektleder</option>
                    <option value="Byggeleder">Byggeleder</option>
                    <option value="Elektriker">Elektriker</option>
                    <option value="VVS-mont√∏r">VVS-mont√∏r</option>
                    <option value="Maler">Maler</option>
                    <option value="T√∏mrer">T√∏mrer</option>
                    <option value="Murer">Murer</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="craftsmanColor">Farve</label>
                <input type="color" class="form-control" id="craftsmanColor" value="#2196F3">
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeModal('craftsmanModal')">Annull√©r</button>
                <button type="button" class="btn btn-primary" onclick="saveCraftsman()">Tilf√∏j</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let appState = {
            project: {
                name: "Capellas All√© 38 - Test",
                address: "Capellas All√© 38, 2770 Kastrup",
                customer: "Test Kunde",
                phone: "+45 50 11 22 03",
                email: "test@switzea.dk",
                startDate: "2025-09-16" // Monday
            },
            craftsmen: [
                {
                    id: 'craftsman_1',
                    name: 'Test H√•ndv√¶rker',
                    color: '#2196F3',
                    order: 0
                }
            ],
            tasks: [],
            weeks: 3,
            startWeekNumber: 37
        };
        
        let currentEditingTask = null;
        let selectedDate = null;
        let isDatepickerOpen = false;
        
        // KRITISK: Date calculation functions
        function getProjectStartDate() {
            return new Date(appState.project.startDate || '2025-09-16');
        }
        
        function calculateDayFromDate(taskDate) {
            const projectStart = getProjectStartDate();
            const task = new Date(taskDate);
            
            // Calculate difference in weekdays only
            let dayCount = 0;
            let currentDate = new Date(projectStart);
            
            while (currentDate < task) {
                if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                    dayCount++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return Math.max(1, dayCount + 1);
        }
        
        function calculateDateFromDay(dayNumber) {
            const projectStart = getProjectStartDate();
            let currentDate = new Date(projectStart);
            let weekdayCount = 0;
            
            while (weekdayCount < dayNumber - 1) {
                currentDate.setDate(currentDate.getDate() + 1);
                if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                    weekdayCount++;
                }
            }
            
            return currentDate;
        }
        
        function formatDateForInput(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function parseDateFromInput(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const year = parseInt(parts[2]);
            return new Date(year, month, day);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß FIXED VERSION LOADING...');
            initializeDatepicker();
            renderAll();
            showToast('üîß FIXED VERSION: Test dato synkronisering!', 'info');
        });
        
        // KRITISK FIX: Real-time date sync
        function initializeDatepicker() {
            const datepickerInput = document.getElementById('taskStartDate');
            const customDatepicker = document.getElementById('customDatepicker');
            const yearSelector = document.getElementById('yearSelector');
            const monthSelector = document.getElementById('monthSelector');
            const prevMonthBtn = document.getElementById('prevMonth');
            const nextMonthBtn = document.getElementById('nextMonth');
            
            // Set current values
            const currentDate = new Date();
            yearSelector.value = currentDate.getFullYear().toString();
            monthSelector.value = currentDate.getMonth().toString();
            
            // Event listeners
            datepickerInput.addEventListener('click', toggleDatepicker);
            yearSelector.addEventListener('change', updateCalendar);
            monthSelector.addEventListener('change', updateCalendar);
            prevMonthBtn.addEventListener('click', previousMonth);
            nextMonthBtn.addEventListener('click', nextMonth);
            
            // Close datepicker when clicking outside
            document.addEventListener('click', function(e) {
                if (!datepickerInput.contains(e.target) && !customDatepicker.contains(e.target)) {
                    hideDatepicker();
                }
            });
            
            updateCalendar();
        }
        
        function toggleDatepicker() {
            const customDatepicker = document.getElementById('customDatepicker');
            if (isDatepickerOpen) {
                hideDatepicker();
            } else {
                customDatepicker.classList.add('show');
                isDatepickerOpen = true;
                updateCalendar();
            }
        }
        
        function hideDatepicker() {
            const customDatepicker = document.getElementById('customDatepicker');
            customDatepicker.classList.remove('show');
            isDatepickerOpen = false;
        }
        
        function previousMonth() {
            const yearSelector = document.getElementById('yearSelector');
            const monthSelector = document.getElementById('monthSelector');
            
            let year = parseInt(yearSelector.value);
            let month = parseInt(monthSelector.value);
            
            month--;
            if (month < 0) {
                month = 11;
                year--;
                if (year < 2025) year = 2025;
            }
            
            yearSelector.value = year.toString();
            monthSelector.value = month.toString();
            updateCalendar();
        }
        
        function nextMonth() {
            const yearSelector = document.getElementById('yearSelector');
            const monthSelector = document.getElementById('monthSelector');
            
            let year = parseInt(yearSelector.value);
            let month = parseInt(monthSelector.value);
            
            month++;
            if (month > 11) {
                month = 0;
                year++;
                if (year > 2030) year = 2030;
            }
            
            yearSelector.value = year.toString();
            monthSelector.value = month.toString();
            updateCalendar();
        }
        
        function updateCalendar() {
            const yearSelector = document.getElementById('yearSelector');
            const monthSelector = document.getElementById('monthSelector');
            const datepickerTitle = document.getElementById('datepickerTitle');
            const calendarDays = document.getElementById('calendarDays');
            
            const year = parseInt(yearSelector.value);
            const month = parseInt(monthSelector.value);
            
            const monthNames = [
                'Januar', 'Februar', 'Marts', 'April', 'Maj', 'Juni',
                'Juli', 'August', 'September', 'Oktober', 'November', 'December'
            ];
            
            datepickerTitle.textContent = `${monthNames[month]} ${year}`;
            
            // Clear calendar
            calendarDays.innerHTML = '';
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Get day of week (Monday = 0)
            let firstDayOfWeek = firstDay.getDay() - 1;
            if (firstDayOfWeek < 0) firstDayOfWeek = 6;
            
            // Add empty cells for previous month
            const prevMonth = month === 0 ? 11 : month - 1;
            const prevYear = month === 0 ? year - 1 : year;
            const daysInPrevMonth = new Date(prevYear, prevMonth + 1, 0).getDate();
            
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const dayDiv = createCalendarDay(daysInPrevMonth - i, prevYear, prevMonth, true);
                calendarDays.appendChild(dayDiv);
            }
            
            // Add days for current month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = createCalendarDay(day, year, month, false);
                calendarDays.appendChild(dayDiv);
            }
            
            // Add days for next month to fill grid
            const totalCells = calendarDays.children.length;
            const remainingCells = 42 - totalCells;
            const nextMonth = month === 11 ? 0 : month + 1;
            const nextYear = month === 11 ? year + 1 : year;
            
            for (let day = 1; day <= Math.min(remainingCells, 14); day++) {
                const dayDiv = createCalendarDay(day, nextYear, nextMonth, true);
                calendarDays.appendChild(dayDiv);
            }
        }
        
        function createCalendarDay(day, year, month, isOtherMonth) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            dayDiv.textContent = day;
            
            if (isOtherMonth) {
                dayDiv.classList.add('other-month');
            }
            
            // Check if it's today
            const today = new Date();
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayDiv.classList.add('today');
            }
            
            // Check if it's selected
            if (selectedDate && 
                selectedDate.getFullYear() === year && 
                selectedDate.getMonth() === month && 
                selectedDate.getDate() === day) {
                dayDiv.classList.add('selected');
            }
            
            dayDiv.addEventListener('click', () => selectDate(year, month, day));
            
            return dayDiv;
        }
        
        // KRITISK FIX: selectDate with REAL-TIME sync
        function selectDate(year, month, day) {
            selectedDate = new Date(year, month, day);
            const dateString = formatDateForInput(selectedDate);
            document.getElementById('taskStartDate').value = dateString;
            
            // REAL-TIME calculation and display
            const calculatedDay = calculateDayFromDate(selectedDate);
            const positionIndicator = document.getElementById('positionIndicator');
            const calculatedPosition = document.getElementById('calculatedPosition');
            
            positionIndicator.style.display = 'block';
            calculatedPosition.textContent = `Dag ${calculatedDay}`;
            
            hideDatepicker();
            updateCalendar();
            
            showToast(`üìÖ Dato valgt: ${dateString} ‚Üí Timeline dag ${calculatedDay}`, 'info');
            console.log(`üîß DATE SYNC: ${dateString} ‚Üí Day ${calculatedDay}`);
        }
        
        function renderAll() {
            renderCraftsmen();
            renderTimeline();
            updateWeekDisplay();
        }
        
        function renderCraftsmen() {
            const list = document.getElementById('craftsmanList');
            list.innerHTML = '';
            
            if (appState.craftsmen.length === 0) {
                list.innerHTML = `
                    <div class="empty-craftsmen">
                        <p>Ingen h√•ndv√¶rkere tilf√∏jet endnu</p>
                        <button class="btn btn-primary" onclick="openCraftsmanModal()">Tilf√∏j f√∏rste h√•ndv√¶rker</button>
                    </div>
                `;
                return;
            }
            
            appState.craftsmen.forEach(craftsman => {
                const li = document.createElement('li');
                li.className = 'craftsman-item';
                li.style.borderLeftColor = craftsman.color;
                
                li.innerHTML = `
                    <span>${craftsman.name}</span>
                    <button class="delete-craftsman" onclick="deleteCraftsman('${craftsman.id}')">√ó</button>
                `;
                
                list.appendChild(li);
            });
        }
        
        function renderTimeline() {
            const grid = document.getElementById('timelineGrid');
            grid.innerHTML = '';
            
            if (appState.craftsmen.length === 0) {
                grid.innerHTML = `
                    <div class="empty-timeline">
                        <p>Tilf√∏j h√•ndv√¶rkere for at se tidslinjen</p>
                    </div>
                `;
                return;
            }
            
            const totalDays = appState.weeks * 5;
            
            // Create header
            const header = document.createElement('div');
            header.className = 'grid-header';
            
            const craftsmanHeader = document.createElement('div');
            craftsmanHeader.className = 'header-craftsman';
            craftsmanHeader.textContent = 'H√•ndv√¶rkere';
            header.appendChild(craftsmanHeader);
            
            const daysHeader = document.createElement('div');
            daysHeader.className = 'header-days';
            
            // Create week sections
            for (let week = 0; week < appState.weeks; week++) {
                const weekSection = document.createElement('div');
                weekSection.className = 'week-section';
                
                const weekHeader = document.createElement('div');
                weekHeader.className = 'week-header';
                weekHeader.textContent = `Uge ${appState.startWeekNumber + week}`;
                weekSection.appendChild(weekHeader);
                
                const daysRow = document.createElement('div');
                daysRow.className = 'days-row';
                
                const days = ['Man', 'Tir', 'Ons', 'Tor', 'Fre'];
                days.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.textContent = day;
                    daysRow.appendChild(dayHeader);
                });
                
                weekSection.appendChild(daysRow);
                daysHeader.appendChild(weekSection);
            }
            
            header.appendChild(daysHeader);
            grid.appendChild(header);
            
            // Create body
            const body = document.createElement('div');
            body.className = 'grid-body';
            
            appState.craftsmen.forEach((craftsman) => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.dataset.craftsman = craftsman.id;
                
                const nameCell = document.createElement('div');
                nameCell.className = 'row-craftsman';
                nameCell.style.borderLeftColor = craftsman.color;
                nameCell.innerHTML = `<span class="craftsman-name">${craftsman.name}</span>`;
                
                row.appendChild(nameCell);
                
                const daysContainer = document.createElement('div');
                daysContainer.className = 'row-days';
                
                for (let day = 1; day <= totalDays; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.day = day;
                    cell.dataset.craftsman = craftsman.id;
                    
                    // Click to create task with calculated date
                    cell.onclick = (e) => {
                        if (e.target === cell) {
                            const taskDate = calculateDateFromDay(day);
                            createTask(craftsman.id, day, taskDate);
                        }
                    };
                    
                    daysContainer.appendChild(cell);
                }
                
                row.appendChild(daysContainer);
                body.appendChild(row);
            });
            
            grid.appendChild(body);
            
            // Render existing tasks
            setTimeout(() => renderTasks(), 50);
        }
        
        function renderTasks() {
            // Remove existing tasks
            document.querySelectorAll('.task').forEach(task => task.remove());
            
            const totalDays = appState.weeks * 5;
            
            appState.tasks.forEach(task => {
                // Skip tasks outside current timeline
                if (task.startDay > totalDays || task.startDay + task.duration - 1 > totalDays) {
                    return;
                }
                
                const craftsmanRow = document.querySelector(`[data-craftsman="${task.craftsman}"]`);
                if (!craftsmanRow) return;
                
                const startCell = craftsmanRow.querySelector(`[data-day="${task.startDay}"]`);
                if (!startCell) return;
                
                const taskElement = document.createElement('div');
                taskElement.className = `task ${task.priority} ${task.status}`;
                if (task.isHalfDay) {
                    taskElement.classList.add('half-day');
                }
                
                taskElement.dataset.taskId = task.id;
                
                // Calculate width based on duration
                const cellWidth = startCell.offsetWidth || 100;
                const width = task.duration * cellWidth - 4;
                taskElement.style.width = `${width}px`;
                taskElement.style.left = '2px';
                
                const taskTitle = task.title.length > 25 ? task.title.substring(0, 25) + '...' : task.title;
                
                taskElement.innerHTML = `
                    <div class="task-title">${taskTitle}</div>
                    <div class="task-controls">
                        <button class="task-btn" onclick="event.stopPropagation(); editTask('${task.id}')">‚úèÔ∏è</button>
                        <button class="task-btn" onclick="event.stopPropagation(); deleteTask('${task.id}')">üóëÔ∏è</button>
                    </div>
                `;
                
                // Double-click to edit
                taskElement.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    editTask(task.id);
                });
                
                startCell.appendChild(taskElement);
            });
        }
        
        function createTask(craftsman, startDay, taskDate = null) {
            const calculatedDate = taskDate || calculateDateFromDay(startDay);
            
            currentEditingTask = null;
            document.getElementById('modalTitle').textContent = 'Ny opgave';
            document.getElementById('deleteTaskBtn').style.display = 'none';
            
            // Clear fields
            clearTaskFields();
            
            // Populate dropdown
            populateCraftsmanDropdown();
            document.getElementById('taskCraftsman').value = craftsman;
            
            // KRITISK: Pre-populate with calculated date
            selectedDate = calculatedDate;
            document.getElementById('taskStartDate').value = formatDateForInput(calculatedDate);
            
            // Show position indicator
            const positionIndicator = document.getElementById('positionIndicator');
            const calculatedPosition = document.getElementById('calculatedPosition');
            positionIndicator.style.display = 'block';
            calculatedPosition.textContent = `Dag ${startDay}`;
            
            document.getElementById('taskModal').classList.add('show');
            
            console.log(`üîß CREATE TASK: Day ${startDay}, Date: ${formatDateForInput(calculatedDate)}`);
        }
        
        function clearTaskFields() {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskNotes').value = '';
            document.getElementById('taskStartDate').value = '';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskStatus').value = 'planned';
            document.getElementById('taskDuration').value = '1';
            document.getElementById('taskHalfDay').checked = false;
            document.getElementById('positionIndicator').style.display = 'none';
            selectedDate = null;
        }
        
        function editTask(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentEditingTask = task;
            document.getElementById('modalTitle').textContent = 'Redig√©r opgave';
            document.getElementById('deleteTaskBtn').style.display = 'inline-block';
            
            document.getElementById('taskModal').classList.add('show');
            
            setTimeout(() => {
                populateCraftsmanDropdown();
                
                document.getElementById('taskTitle').value = task.title || '';
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskNotes').value = task.notes || '';
                
                // KRITISK: Set date and show position
                if (task.startDate) {
                    const date = new Date(task.startDate);
                    document.getElementById('taskStartDate').value = formatDateForInput(date);
                    selectedDate = date;
                } else if (task.startDay) {
                    const calculatedDate = calculateDateFromDay(task.startDay);
                    document.getElementById('taskStartDate').value = formatDateForInput(calculatedDate);
                    selectedDate = calculatedDate;
                }
                
                // Show position indicator
                const positionIndicator = document.getElementById('positionIndicator');
                const calculatedPosition = document.getElementById('calculatedPosition');
                positionIndicator.style.display = 'block';
                calculatedPosition.textContent = `Dag ${task.startDay}`;
                
                document.getElementById('taskCraftsman').value = task.craftsman || '';
                document.getElementById('taskPriority').value = task.priority || 'medium';
                document.getElementById('taskStatus').value = task.status || 'planned';
                document.getElementById('taskDuration').value = String(task.duration || 1);
                document.getElementById('taskHalfDay').checked = Boolean(task.isHalfDay);
                
                console.log(`üîß EDIT TASK: ${task.title}, Day: ${task.startDay}, Date: ${task.startDate}`);
            }, 100);
        }
        
        function populateCraftsmanDropdown() {
            const select = document.getElementById('taskCraftsman');
            select.innerHTML = '<option value="">V√¶lg h√•ndv√¶rker...</option>';
            appState.craftsmen.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                select.appendChild(option);
            });
        }
        
        // KRITISK FIX: saveTask with GUARANTEED date sync
        function saveTask() {
            const startDateInput = document.getElementById('taskStartDate').value;
            const startDate = parseDateFromInput(startDateInput);
            
            let calculatedDay = 1;
            if (startDate) {
                calculatedDay = calculateDayFromDate(startDate);
                console.log(`üîß SAVE TASK: Date ${startDateInput} ‚Üí Day ${calculatedDay}`);
            }
            
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                notes: document.getElementById('taskNotes').value,
                startDate: startDate ? startDate.toISOString().split('T')[0] : null,
                startDay: calculatedDay,
                craftsman: document.getElementById('taskCraftsman').value,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                duration: parseFloat(document.getElementById('taskDuration').value),
                isHalfDay: document.getElementById('taskHalfDay').checked
            };
            
            if (currentEditingTask) {
                Object.assign(currentEditingTask, taskData);
                showToast(`‚úÖ Opgave opdateret ‚Üí Dag ${calculatedDay}!`);
                console.log(`üîß UPDATED TASK: ${currentEditingTask.id} ‚Üí Day ${calculatedDay}`);
            } else {
                const newTask = {
                    id: 'task_' + Date.now(),
                    dependencies: [],
                    ...taskData
                };
                appState.tasks.push(newTask);
                showToast(`‚úÖ Ny opgave oprettet p√• dag ${calculatedDay}!`);
                console.log(`üîß CREATED TASK: ${newTask.id} ‚Üí Day ${calculatedDay}`);
            }
            
            renderAll();
            closeModal('taskModal');
        }
        
        function deleteCurrentTask() {
            if (currentEditingTask && confirm('Er du sikker p√• at du vil slette denne opgave?')) {
                appState.tasks = appState.tasks.filter(t => t.id !== currentEditingTask.id);
                renderAll();
                closeModal('taskModal');
                showToast('Opgave slettet');
            }
        }
        
        function deleteTask(taskId) {
            if (confirm('Er du sikker p√• at du vil slette denne opgave?')) {
                appState.tasks = appState.tasks.filter(t => t.id !== taskId);
                renderAll();
                showToast('Opgave slettet');
            }
        }
        
        function openCraftsmanModal() {
            document.getElementById('craftsmanType').value = '';
            document.getElementById('craftsmanColor').value = '#2196F3';
            document.getElementById('craftsmanModal').classList.add('show');
        }
        
        function saveCraftsman() {
            const type = document.getElementById('craftsmanType').value;
            const color = document.getElementById('craftsmanColor').value;
            
            if (!type) {
                showToast('V√¶lg en h√•ndv√¶rkertype', 'warning');
                return;
            }
            
            const id = 'craftsman_' + Date.now();
            const newCraftsman = {
                id: id,
                name: type,
                color: color,
                order: appState.craftsmen.length
            };
            
            appState.craftsmen.push(newCraftsman);
            renderAll();
            closeModal('craftsmanModal');
            showToast('H√•ndv√¶rker tilf√∏jet');
        }
        
        function deleteCraftsman(craftsmanId) {
            if (confirm('Er du sikker p√• at du vil slette denne h√•ndv√¶rker? Alle tilh√∏rende opgaver vil ogs√• blive slettet.')) {
                appState.craftsmen = appState.craftsmen.filter(c => c.id !== craftsmanId);
                appState.tasks = appState.tasks.filter(t => t.craftsman !== craftsmanId);
                renderAll();
                showToast('H√•ndv√¶rker slettet');
            }
        }
        
        function addWeek() {
            appState.weeks++;
            renderAll();
            showToast('Uge tilf√∏jet');
        }
        
        function removeWeek() {
            if (appState.weeks > 1) {
                appState.weeks--;
                renderAll();
                showToast('Uge fjernet');
            }
        }
        
        function updateWeekDisplay() {
            document.getElementById('weekDisplay').textContent = `${appState.weeks} uger`;
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            hideDatepicker();
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // TEST FUNCTIONS
        function testDateSync() {
            showToast('üß™ Test: Opret ny opgave og v√¶lg forskellig dato!', 'info');
            createTask('craftsman_1', 1, new Date('2025-09-16'));
        }
        
        function resetTestData() {
            appState.tasks = [];
            renderAll();
            showToast('üîÑ Test data nulstillet - pr√∏v igen!', 'info');
        }
        
        console.log('üîß SWITZEA FIXED VERSION LOADED - Date sync should work now!');
    </script>
</body>
</html>
