<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switzea - Projekt Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f5f7fa;
            overflow-x: hidden;
            user-select: none;
        }
        
        .company-banner {
            background: linear-gradient(135deg, #2E7D32, #4CAF50);
            color: white;
            text-align: center;
            padding: 15px;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header h1 { 
            font-size: 2rem; 
            margin-bottom: 0.5rem; 
        }
        
        .project-info { 
            font-size: 1rem; 
            opacity: 0.9; 
        }
        
        .empty-project { 
            font-style: italic; 
            opacity: 0.7; 
        }
        
        .header-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s;
            font-family: inherit;
            white-space: nowrap;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-outline { background: transparent; color: white; border: 2px solid white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-import { background: linear-gradient(135deg, #e91e63, #ad1457); color: white; }
        .btn-completion { background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; }
        
        .btn:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(0,0,0,0.2); 
        }
        
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
        }
        
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 2rem auto;
            gap: 2rem;
            padding: 0 1rem;
        }
        
        .sidebar {
            width: 300px;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .timeline-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .craftsman-list {
            list-style: none;
        }
        
        .craftsman-item {
            padding: 1rem;
            margin: 0.5rem 0;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            border-left: 5px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: grab;
            position: relative;
        }
        
        .craftsman-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .craftsman-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg) scale(0.95);
            z-index: 1000;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .empty-craftsmen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
            font-style: italic;
            text-align: center;
        }
        
        .empty-craftsmen p {
            margin-bottom: 1rem;
        }
        
        .week-controls {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .timeline-info {
            font-weight: 600;
            color: #333;
            background: #e3f2fd;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.95rem;
        }
        
        .week-number-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .week-number-input input {
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .week-number-input input:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .timeline-grid {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .empty-timeline {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #666;
            font-style: italic;
            text-align: center;
        }
        
        .empty-timeline h3 {
            margin-bottom: 1rem;
            color: #999;
        }
        
        .grid-header {
            display: flex;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-bottom: 3px solid #dee2e6;
            font-weight: bold;
            min-height: 70px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .header-craftsman {
            min-width: 200px;
            max-width: 200px;
            padding: 1rem;
            border-right: 3px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #e9ecef, #d6d8db);
            font-size: 1.1rem;
            color: #495057;
            font-weight: 600;
        }
        
        .header-days {
            flex: 1;
            display: flex;
        }
        
        .week-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #dee2e6;
        }
        
        .week-section:last-child {
            border-right: none;
        }
        
        .week-header {
            padding: 0.5rem;
            background: linear-gradient(145deg, #d6d8db, #c6c8ca);
            border-bottom: 1px solid #dee2e6;
            text-align: center;
            font-weight: bold;
            font-size: 0.85rem;
            line-height: 1.2;
        }
        
        .week-date-range {
            font-size: 0.7rem;
            color: #555;
            font-weight: normal;
            margin-top: 2px;
        }
        
        .days-row {
            display: flex;
            flex: 1;
        }
        
        .day-header {
            flex: 1;
            padding: 0.5rem 0.25rem;
            border-right: 1px solid #dee2e6;
            text-align: center;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 0.75rem;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            line-height: 1.1;
        }
        
        .day-header:last-child { 
            border-right: none; 
        }
        
        .day-name {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .day-date {
            font-size: 0.65rem;
            color: #666;
        }
        
        .day-header.weekend {
            background: linear-gradient(145deg, #ffebee, #ffcdd2);
            color: #c62828;
        }
        
        .day-header.today {
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            color: #1976d2;
            font-weight: bold;
        }
        
        .grid-body {
            flex: 1;
            overflow-y: auto;
            max-height: 600px;
        }
        
        .grid-row {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            min-height: 80px;
            position: relative;
        }
        
        .grid-row:nth-child(even) { 
            background: #fafbfc; 
        }
        
        .row-craftsman {
            min-width: 200px;
            max-width: 200px;
            padding: 1rem;
            border-right: 3px solid #dee2e6;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 6px solid;
            position: sticky;
            left: 0;
            z-index: 5;
            box-shadow: 2px 0 3px rgba(0,0,0,0.1);
        }
        
        .craftsman-name {
            flex: 1;
        }
        
        .row-days {
            flex: 1;
            display: flex;
        }
        
        .grid-cell {
            flex: 1;
            border-right: 1px solid #dee2e6;
            position: relative;
            transition: all 0.2s;
            min-height: 80px;
            cursor: pointer;
        }
        
        .grid-cell:last-child { 
            border-right: none; 
        }
        
        .grid-cell:hover { 
            background: #e3f2fd; 
        }
        
        .grid-cell.drop-zone { 
            background: #c8e6c9 !important; 
            border: 2px dashed #4CAF50 !important;
        }
        
        .grid-cell.weekend {
            background: #fafafa;
        }
        
        .grid-cell.today {
            background: #e8f5e8;
            border-left: 3px solid #4CAF50;
        }
        
        .task {
            position: absolute;
            background: linear-gradient(145deg, #2196F3, #1976D2);
            color: white;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: move;
            font-size: 0.75rem;
            line-height: 1.2;
            z-index: 3;
            transition: all 0.2s;
            border: 2px solid transparent;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            top: 10px;
            left: 2px;
            right: 2px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .task:hover:not(.dragging) {
            transform: scale(1.02) translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
            z-index: 4;
        }
        
        .task.dragging {
            opacity: 0.7;
            transform: rotate(5deg) scale(1.05);
            z-index: 100;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .task.high { 
            border-left: 6px solid #f44336; 
            background: linear-gradient(145deg, #e53935, #c62828);
        }
        .task.medium { 
            border-left: 6px solid #ff9800; 
            background: linear-gradient(145deg, #fb8c00, #ef6c00);
        }
        .task.low { 
            border-left: 6px solid #4caf50; 
            background: linear-gradient(145deg, #43a047, #388e3c);
        }
        
        .task.planned { 
            background: linear-gradient(145deg, #6c757d, #5a6268); 
        }
        .task.in-progress { 
            background: linear-gradient(145deg, #2196F3, #1976D2); 
        }
        .task.completed { 
            background: linear-gradient(145deg, #4CAF50, #388E3C); 
        }
        
        .task.half-day {
            height: 40px !important;
            font-size: 0.7rem;
            padding: 0.25rem;
        }
        
        .task-title {
            font-weight: bold;
            font-size: 0.75rem;
            pointer-events: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            margin-bottom: 0.2rem;
        }
        
        .task-controls {
            display: flex;
            gap: 0.25rem;
            margin-top: auto;
        }
        
        .task-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.65rem;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            z-index: 10;
        }
        
        .task-btn:hover { 
            background: rgba(255,255,255,0.4);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal.show { 
            display: flex; 
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        
        .modal.show .modal-content { 
            transform: scale(1); 
        }
        
        .modal h3 {
            margin-bottom: 1.5rem;
            color: #333;
            font-size: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }
        
        .file-upload-area {
            border: 3px dashed #ff9800;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            background: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: #f57c00;
            background: rgba(255,255,255,0.9);
        }
        
        .file-upload-area.dragover {
            border-color: #e65100;
            background: #fff3e0;
        }
        
        .csv-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .task-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: normal;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            max-width: 300px;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .task-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: #4CAF50;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            font-weight: 500;
            max-width: 350px;
        }
        
        .toast.show { 
            transform: translateX(0); 
        }
        .toast.error { 
            background: #f44336; 
        }
        .toast.warning { 
            background: #ff9800; 
        }
        .toast.info { 
            background: #2196F3; 
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                margin: 1rem;
                padding: 0;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .header-buttons {
                justify-content: center;
                width: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .btn {
                font-size: 0.85rem;
                padding: 0.6rem 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="company-banner">
        🏗️ SWITZEA ApS - Professionelt Projekt Management System
    </div>

    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <h1 id="projectTitle">Nyt Projekt</h1>
                <div class="project-info" id="projectInfo">
                    <span class="empty-project">Klik "Redigér Projekt" for at tilføje kunde information</span>
                </div>
            </div>
            <div class="header-buttons">
                <button class="btn btn-outline" onclick="editProject()">✏️ Redigér Projekt</button>
                <button class="btn btn-secondary" id="undoBtn" onclick="undo()">↺ Fortryd</button>
                <button class="btn btn-secondary" id="redoBtn" onclick="redo()">↻ Gendan</button>
                <button class="btn btn-primary" onclick="saveProjectToStorage()">💾 Gem</button>
                <button class="btn btn-secondary" onclick="loadProjectFromStorage()">📂 Indlæs</button>
                <button class="btn btn-import" onclick="openImportModal()">📁 Importér CSV</button>
                <button class="btn btn-success" onclick="exportWorkerPDF()">📋 Håndværker PDF</button>
                <button class="btn btn-outline" onclick="exportCustomerPDF()">📊 Kunde PDF</button>
                <button class="btn btn-completion" onclick="exportCompletionReport()">🏁 Afslutnings Rapport</button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <div class="section-title">
                👥 Håndværkere 
                <button class="btn btn-primary" onclick="openCraftsmanModal()" style="font-size: 0.8rem; padding: 0.5rem 1rem;">+ Tilføj</button>
            </div>
            <ul class="craftsman-list" id="craftsmanList">
                <div class="empty-craftsmen">
                    <p>Ingen håndværkere tilføjet endnu</p>
                    <button class="btn btn-primary" onclick="openCraftsmanModal()">Tilføj første håndværker</button>
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 0.9em;">
                        💡 <strong>Tip:</strong><br>
                        Prøv <span style="color: #1976d2;">"📁 Importér CSV"</span> for at importere opgaver!
                    </div>
                </div>
            </ul>
        </div>

        <div class="timeline-container">
            <div class="week-controls">
                <button class="btn btn-secondary" onclick="removeWeek()">− Fjern uge</button>
                <span id="weekDisplay">3 uger</span>
                <button class="btn btn-secondary" onclick="addWeek()">+ Tilføj uge</button>
                
                <div class="timeline-info" id="timelineInfo">
                    Projekt: Start dato mangler
                </div>
                
                <div class="week-number-input">
                    <label>Start:</label>
                    <input type="date" id="projectStartDate" value="" onchange="updateProjectStartDate()">
                </div>
            </div>
            
            <div class="timeline-grid" id="timelineGrid">
                <div class="empty-timeline">
                    <h3>Timeline klar når du har:</h3>
                    <p>• Tilføjet håndværkere</p>
                    <p>• Sat projektets startdato</p>
                    <p>• Tilføjet opgaver</p>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-import" onclick="openImportModal()">📁 Importér CSV opgaver</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h3 id="modalTitle">Ny opgave</h3>
            
            <div class="form-group">
                <label for="taskTitle">Opgavetitel</label>
                <input type="text" class="form-control" id="taskTitle" placeholder="f.eks. Nedrivning af vægge">
            </div>
            
            <div class="form-group">
                <label for="taskDescription">Beskrivelse</label>
                <textarea class="form-control" id="taskDescription" rows="3" placeholder="Detaljeret beskrivelse af opgaven"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="taskStartDate">Startdato</label>
                    <input type="date" class="form-control" id="taskStartDate">
                </div>
                <div class="form-group">
                    <label for="taskDuration">Varighed (dage)</label>
                    <input type="number" class="form-control" id="taskDuration" min="0.5" step="0.5" value="1">
                </div>
            </div>
            
            <div class="form-group">
                <label for="taskNotes">Noter/Kommentarer</label>
                <textarea class="form-control" id="taskNotes" rows="2" placeholder="Materialer, koordinering, problemer..."></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="taskCraftsman">Håndværker</label>
                    <select class="form-control" id="taskCraftsman">
                        <option value="">Vælg håndværker...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="taskPriority">Prioritet</label>
                    <select class="form-control" id="taskPriority">
                        <option value="low">Lav</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">Høj</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="taskStatus">Status</label>
                    <select class="form-control" id="taskStatus">
                        <option value="planned" selected>Planlagt</option>
                        <option value="in-progress">I gang</option>
                        <option value="completed">Udført</option>
                    </select>
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="taskHalfDay">
                    <label for="taskHalfDay">Halv dag opgave</label>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-danger" id="deleteTaskBtn" style="display: none;" onclick="deleteCurrentTask()">Slet opgave</button>
                <button type="button" class="btn btn-outline" onclick="closeModal('taskModal')">Annullér</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">Gem opgave</button>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <h3>📝 Projekt Information</h3>
            <div class="form-group">
                <label for="projectName">Projekt Navn</label>
                <input type="text" class="form-control" id="projectName" placeholder="f.eks. Køkkenrenovering">
            </div>
            
            <div class="form-group">
                <label for="customerName">Kunde Navn</label>
                <input type="text" class="form-control" id="customerName" placeholder="Fornavn og efternavn">
            </div>
            
            <div class="form-group">
                <label for="projectAddress">Adresse</label>
                <input type="text" class="form-control" id="projectAddress" placeholder="Vej, nummer, postnummer og by">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="customerPhone">Telefon</label>
                    <input type="tel" class="form-control" id="customerPhone" placeholder="+45 12 34 56 78">
                </div>
                
                <div class="form-group">
                    <label for="customerEmail">E-mail</label>
                    <input type="email" class="form-control" id="customerEmail" placeholder="kunde@email.dk">
                </div>
            </div>
            
            <div class="form-group">
                <label for="startDate">Projekt Start Dato</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-outline" onclick="closeModal('projectModal')">Annullér</button>
                <button type="button" class="btn btn-primary" onclick="saveProject()">💾 Gem Projekt</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h3>📁 Importér Opgaver fra CSV</h3>
            
            <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 5px solid #4CAF50;">
                <h4 style="margin-bottom: 1rem; color: #2e7d32;">📋 CSV Format:</h4>
                <div style="font-family: 'Courier New', monospace; font-size: 0.85em; background: white; padding: 1rem; border-radius: 5px;">
                    Titel,Beskrivelse,Håndværker,Startdato,Varighed,Prioritet,Status,Noter<br>
                    Nedrivning,Fjern gamle elementer,Tømrer,2025-09-05,2,høj,planlagt,Husk container
                </div>
            </div>
            
            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('csvFileInput').click()">
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                <div style="font-size: 1.2em; margin-bottom: 0.5rem;">📁 Vælg CSV fil eller træk & slip her</div>
                <div style="font-size: 0.9em; color: #666;">Understøtter .csv filer</div>
            </div>
            
            <div id="csvPreview" class="csv-preview" style="display: none;"></div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-outline" onclick="closeModal('importModal')">Annullér</button>
                <button type="button" class="btn btn-import" id="importBtn" onclick="processImport()" disabled>📥 Importér Data</button>
            </div>
        </div>
    </div>

    <!-- Craftsman Modal -->
    <div class="modal" id="craftsmanModal">
        <div class="modal-content">
            <h3>👤 Tilføj Håndværker</h3>
            
            <div class="form-group">
                <label for="craftsmanType">Håndværkertype</label>
                <select class="form-control" id="craftsmanType">
                    <option value="">Vælg type...</option>
                    <option value="Elektriker">Elektriker</option>
                    <option value="VVS-montør">VVS-montør</option>
                    <option value="Tømrer">Tømrer</option>
                    <option value="Maler">Maler</option>
                    <option value="Murer">Murer</option>
                    <option value="Gulvlægger">Gulvlægger</option>
                    <option value="Rengøringsassistent">Rengøringsassistent</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="craftsmanColor">Farve</label>
                <input type="color" class="form-control" id="craftsmanColor" value="#2196F3">
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-outline" onclick="closeModal('craftsmanModal')">Annullér</button>
                <button type="button" class="btn btn-primary" onclick="saveCraftsman()">➕ Tilføj</button>
            </div>
        </div>
    </div>

    <!-- Tooltip element -->
    <div class="task-tooltip" id="taskTooltip"></div>

    <script>
        // Application State
        let appState = {
            project: {
                name: "",
                address: "",
                customer: "",
                phone: "",
                email: "",
                startDate: ""
            },
            craftsmen: [],
            tasks: [],
            weeks: 3,
            startWeekNumber: 1
        };
        
        let history = [];
        let historyIndex = -1;
        let currentEditingTask = null;
        let taskBackup = null;
        let draggedElement = null;
        let draggedType = null;
        let tooltipTimeout = null;
        let importData = null;
        
        // Date calculation functions 
        function getProjectStartDate() {
            if (!appState.project.startDate) {
                const today = new Date();
                return today;
            }
            return new Date(appState.project.startDate);
        }
        
        function calculateDayFromDate(taskDate) {
            const projectStart = getProjectStartDate();
            const task = new Date(taskDate);
            
            let dayCount = 0;
            let currentDate = new Date(projectStart);
            
            while (currentDate < task) {
                if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                    dayCount++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return dayCount + 1;
        }
        
        function calculateDateFromDay(dayNumber) {
            const projectStart = getProjectStartDate();
            let currentDate = new Date(projectStart);
            let weekdayCount = 1;
            
            if (dayNumber === 1) {
                return new Date(projectStart);
            }
            
            while (weekdayCount < dayNumber) {
                currentDate.setDate(currentDate.getDate() + 1);
                if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                    weekdayCount++;
                }
            }
            
            return currentDate;
        }
        
        function getWeekDateRange(weekNumber) {
            const projectStart = getProjectStartDate();
            const weekStart = new Date(projectStart);
            weekStart.setDate(weekStart.getDate() + (weekNumber - 1) * 7);
            
            const dayOfWeek = weekStart.getDay();
            const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            weekStart.setDate(weekStart.getDate() + mondayOffset);
            
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 4);
            
            return {
                start: weekStart,
                end: weekEnd
            };
        }
        
        function formatDateForDisplay(date) {
            return date.toLocaleDateString('da-DK', { 
                day: '2-digit', 
                month: '2-digit' 
            });
        }
        
        function formatDateForInput(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }
        
        function isWeekend(date) {
            return date.getDay() === 0 || date.getDay() === 6;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            saveState();
            renderAll();
            updateTimelineInfo();
            setupFileUpload();
            showToast('🏗️ Switzea System klar - importér CSV for at komme i gang!', 'info');
        });
        
        // STATE MANAGEMENT
        function saveState() {
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            history.push(JSON.stringify(appState));
            historyIndex++;
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }
            updateUndoRedoButtons();
        }
        
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                appState = JSON.parse(history[historyIndex]);
                renderAll();
                updateTimelineInfo();
                updateUndoRedoButtons();
                showToast('↺ Handling fortrudt');
            }
        }
        
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                appState = JSON.parse(history[historyIndex]);
                renderAll();
                updateTimelineInfo();
                updateUndoRedoButtons();
                showToast('↻ Handling gendannet');
            }
        }
        
        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn) undoBtn.disabled = historyIndex <= 0;
            if (redoBtn) redoBtn.disabled = historyIndex >= history.length - 1;
        }
        
        // FILE UPLOAD SYSTEM
        function setupFileUpload() {
            const uploadArea = document.getElementById('fileUploadArea');
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        }
        
        function openImportModal() {
            document.getElementById('importModal').classList.add('show');
            document.getElementById('csvPreview').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
            importData = null;
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showToast('Kun CSV filer understøttes', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => parseCSV(e.target.result);
            reader.readAsText(file, 'UTF-8');
        }
        
        function parseCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                showToast('CSV skal indeholde header og mindst en data række', 'error');
                return;
            }
            
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.toLowerCase()] = values[index] ? values[index].trim() : '';
                    });
                    rows.push(row);
                }
            }
            
            if (rows.length === 0) {
                showToast('Ingen gyldige data rækker fundet', 'error');
                return;
            }
            
            importData = rows;
            displayCSVPreview(headers, rows);
            document.getElementById('importBtn').disabled = false;
        }
        
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current);
            return values.map(v => v.replace(/^"|"$/g, ''));
        }
        
        function displayCSVPreview(headers, rows) {
            const preview = document.getElementById('csvPreview');
            const maxRows = Math.min(rows.length, 3);
            
            let html = '<strong>📊 Data preview:</strong><br><br>';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.8em;">';
            
            html += '<tr>';
            headers.forEach(header => {
                html += `<th style="border: 1px solid #ddd; padding: 5px; background: #f5f5f5;">${header}</th>`;
            });
            html += '</tr>';
            
            for (let i = 0; i < maxRows; i++) {
                html += '<tr>';
                headers.forEach(header => {
                    const value = rows[i][header.toLowerCase()] || '';
                    html += `<td style="border: 1px solid #ddd; padding: 5px;">${value}</td>`;
                });
                html += '</tr>';
            }
            
            html += '</table>';
            
            if (rows.length > maxRows) {
                html += `<br><em>... og ${rows.length - maxRows} flere rækker</em>`;
            }
            
            preview.innerHTML = html;
            preview.style.display = 'block';
        }
        
        function processImport() {
            if (!importData || importData.length === 0) {
                showToast('Ingen data at importere', 'error');
                return;
            }
            
            let importedTasks = 0;
            let createdCraftsmen = 0;
            const existingCraftsmen = new Map(appState.craftsmen.map(c => [c.name.toLowerCase(), c]));
            
            importData.forEach((row, index) => {
                try {
                    const title = row.titel || row.title || `Opgave ${index + 1}`;
                    const description = row.beskrivelse || row.description || '';
                    const craftsmanName = row.håndværker || row.craftsman || 'Specialist';
                    const notes = row.noter || row.notes || '';
                    
                    let startDate = new Date();
                    if (row.startdato || row.startdate) {
                        const parsed = new Date(row.startdato || row.startdate);
                        if (!isNaN(parsed.getTime())) startDate = parsed;
                    }
                    
                    let duration = parseFloat(row.varighed || row.duration || '1');
                    if (isNaN(duration) || duration <= 0) duration = 1;
                    
                    const priorityStr = (row.prioritet || row.priority || 'medium').toLowerCase();
                    let priority = 'medium';
                    if (priorityStr.includes('høj') || priorityStr.includes('high')) priority = 'high';
                    if (priorityStr.includes('lav') || priorityStr.includes('low')) priority = 'low';
                    
                    const statusStr = (row.status || 'planlagt').toLowerCase();
                    let status = 'planned';
                    if (statusStr.includes('gang') || statusStr.includes('progress')) status = 'in-progress';
                    if (statusStr.includes('udført') || statusStr.includes('completed')) status = 'completed';
                    
                    let craftsman = existingCraftsmen.get(craftsmanName.toLowerCase());
                    if (!craftsman) {
                        const colors = ['#2196F3', '#4CAF50', '#FF9800', '#9C27B0', '#F44336', '#00BCD4'];
                        craftsman = {
                            id: 'craftsman_' + Date.now() + '_' + createdCraftsmen,
                            name: craftsmanName,
                            color: colors[createdCraftsmen % colors.length],
                            order: appState.craftsmen.length + createdCraftsmen
                        };
                        appState.craftsmen.push(craftsman);
                        existingCraftsmen.set(craftsmanName.toLowerCase(), craftsman);
                        createdCraftsmen++;
                    }
                    
                    const startDay = appState.project.startDate ? 
                        calculateDayFromDate(startDate) : 
                        appState.tasks.length + 1;
                    
                    const newTask = {
                        id: 'task_import_' + Date.now() + '_' + index,
                        title: title,
                        description: description,
                        notes: notes,
                        startDate: startDate.toISOString().split('T')[0],
                        startDay: startDay,
                        duration: duration,
                        craftsman: craftsman.id,
                        priority: priority,
                        status: status,
                        isHalfDay: duration < 1,
                        dependencies: []
                    };
                    
                    appState.tasks.push(newTask);
                    importedTasks++;
                    
                } catch (error) {
                    console.error('Error processing row:', error);
                }
            });
            
            saveState();
            renderAll();
            updateTimelineInfo();
            closeModal('importModal');
            
            showToast(`✅ Import komplet! ${importedTasks} opgaver og ${createdCraftsmen} nye håndværkere`, 'success');
        }
        
        // RENDERING FUNCTIONS
        function renderAll() {
            renderProjectInfo();
            renderCraftsmen();
            renderTimeline();
            updateWeekDisplay();
            
            if (appState.project.startDate) {
                document.getElementById('projectStartDate').value = appState.project.startDate;
            }
        }
        
        function renderProjectInfo() {
            const titleElement = document.getElementById('projectTitle');
            const infoElement = document.getElementById('projectInfo');
            
            if (appState.project.name) {
                titleElement.textContent = appState.project.name;
                let infoText = '';
                if (appState.project.address) infoText += appState.project.address;
                if (appState.project.customer) infoText += (infoText ? ' • ' : '') + appState.project.customer;
                if (appState.project.phone) infoText += (infoText ? ' • ' : '') + appState.project.phone;
                
                infoElement.innerHTML = infoText || '<span class="empty-project">Tilføj projekt detaljer</span>';
                infoElement.className = 'project-info';
            } else {
                titleElement.textContent = 'Nyt Projekt';
                infoElement.innerHTML = '<span class="empty-project">Klik "Redigér Projekt" for at tilføje kunde information</span>';
                infoElement.className = 'project-info';
            }
        }
        
        function renderCraftsmen() {
            const list = document.getElementById('craftsmanList');
            list.innerHTML = '';
            
            if (appState.craftsmen.length === 0) {
                list.innerHTML = `
                    <div class="empty-craftsmen">
                        <p>Ingen håndværkere tilføjet endnu</p>
                        <button class="btn btn-primary" onclick="openCraftsmanModal()">Tilføj første håndværker</button>
                        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 0.9em;">
                            💡 <strong>Tip:</strong><br>
                            Prøv <span style="color: #1976d2;">"📁 Importér CSV"</span> for at importere opgaver!
                        </div>
                    </div>
                `;
                return;
            }
            
            const sortedCraftsmen = [...appState.craftsmen].sort((a, b) => a.order - b.order);
            
            sortedCraftsmen.forEach(craftsman => {
                const li = document.createElement('li');
                li.className = 'craftsman-item';
                li.style.borderLeftColor = craftsman.color;
                li.draggable = true;
                li.dataset.id = craftsman.id;
                
                li.innerHTML = `
                    <span>${craftsman.name}</span>
                    <button class="delete-btn" onclick="deleteCraftsman('${craftsman.id}')">×</button>
                `;
                
                list.appendChild(li);
            });
        }
        
        function renderTimeline() {
            const grid = document.getElementById('timelineGrid');
            grid.innerHTML = '';
            
            if (appState.craftsmen.length === 0 || !appState.project.startDate) {
                grid.innerHTML = `
                    <div class="empty-timeline">
                        <h3>Timeline klar når du har:</h3>
                        <p>• Tilføjet håndværkere</p>
                        <p>• Sat projektets startdato</p>
                        <p>• Tilføjet opgaver</p>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-import" onclick="openImportModal()">📁 Importér CSV opgaver</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Create timeline structure
            const header = document.createElement('div');
            header.className = 'grid-header';
            
            const headerCraftsman = document.createElement('div');
            headerCraftsman.className = 'header-craftsman';
            headerCraftsman.textContent = 'Håndværkere';
            header.appendChild(headerCraftsman);
            
            const headerDays = document.createElement('div');
            headerDays.className = 'header-days';
            
            // Generate week headers
            for (let week = 1; week <= appState.weeks; week++) {
                const weekSection = document.createElement('div');
                weekSection.className = 'week-section';
                
                const weekHeader = document.createElement('div');
                weekHeader.className = 'week-header';
                const dateRange = getWeekDateRange(week);
                weekHeader.innerHTML = `
                    Uge ${week}<br>
                    <div class="week-date-range">${formatDateForDisplay(dateRange.start)} - ${formatDateForDisplay(dateRange.end)}</div>
                `;
                
                const daysRow = document.createElement('div');
                daysRow.className = 'days-row';
                
                // Generate day headers (Mon-Fri)
                const dayNames = ['Man', 'Tir', 'Ons', 'Tor', 'Fre'];
                for (let day = 0; day < 5; day++) {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    
                    const dayDate = new Date(dateRange.start);
                    dayDate.setDate(dayDate.getDate() + day);
                    
                    if (isToday(dayDate)) {
                        dayHeader.classList.add('today');
                    }
                    if (isWeekend(dayDate)) {
                        dayHeader.classList.add('weekend');
                    }
                    
                    dayHeader.innerHTML = `
                        <div class="day-name">${dayNames[day]}</div>
                        <div class="day-date">${formatDateForDisplay(dayDate)}</div>
                    `;
                    
                    daysRow.appendChild(dayHeader);
                }
                
                weekSection.appendChild(weekHeader);
                weekSection.appendChild(daysRow);
                headerDays.appendChild(weekSection);
            }
            
            header.appendChild(headerDays);
            grid.appendChild(header);
            
            // Create grid body
            const body = document.createElement('div');
            body.className = 'grid-body';
            
            // Generate craftsman rows
            const sortedCraftsmen = [...appState.craftsmen].sort((a, b) => a.order - b.order);
            sortedCraftsmen.forEach(craftsman => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                
                const rowCraftsman = document.createElement('div');
                rowCraftsman.className = 'row-craftsman';
                rowCraftsman.style.borderLeftColor = craftsman.color;
                rowCraftsman.innerHTML = `
                    <span class="craftsman-name">${craftsman.name}</span>
                `;
                
                const rowDays = document.createElement('div');
                rowDays.className = 'row-days';
                
                // Generate cells for each day
                const totalDays = appState.weeks * 5;
                for (let dayIndex = 0; dayIndex < totalDays; dayIndex++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.craftsman = craftsman.id;
                    cell.dataset.day = dayIndex + 1;
                    
                    const dayDate = calculateDateFromDay(dayIndex + 1);
                    if (isToday(dayDate)) {
                        cell.classList.add('today');
                    }
                    if (isWeekend(dayDate)) {
                        cell.classList.add('weekend');
                    }
                    
                    // Add click handler for creating new tasks
                    cell.addEventListener('click', (e) => {
                        if (e.target === cell) {
                            createTaskAtCell(craftsman.id, dayIndex + 1);
                        }
                    });
                    
                    rowDays.appendChild(cell);
                }
                
                row.appendChild(rowCraftsman);
                row.appendChild(rowDays);
                body.appendChild(row);
            });
            
            grid.appendChild(body);
            
            // Render tasks
            renderTasks();
        }
        
        function renderTasks() {
            // Clear existing tasks
            document.querySelectorAll('.task').forEach(task => task.remove());
            
            appState.tasks.forEach(task => {
                const craftsman = appState.craftsmen.find(c => c.id === task.craftsman);
                if (!craftsman) return;
                
                const cell = document.querySelector(`[data-craftsman="${task.craftsman}"][data-day="${task.startDay}"]`);
                if (!cell) return;
                
                const taskElement = document.createElement('div');
                taskElement.className = `task ${task.priority} ${task.status} ${task.isHalfDay ? 'half-day' : ''}`;
                taskElement.dataset.taskId = task.id;
                taskElement.draggable = true;
                
                // Calculate width for multi-day tasks
                const endDay = task.startDay + Math.ceil(task.duration) - 1;
                const totalDays = Math.min(Math.ceil(task.duration), appState.weeks * 5 - task.startDay + 1);
                
                if (totalDays > 1) {
                    const cellWidth = cell.offsetWidth;
                    taskElement.style.width = `${cellWidth * totalDays + (totalDays - 1)}px`;
                }
                
                taskElement.innerHTML = `
                    <div class="task-title">${task.title}</div>
                    <div class="task-controls">
                        <button class="task-btn" onclick="editTask('${task.id}')">✏️</button>
                        <button class="task-btn" onclick="deleteTask('${task.id}')">🗑️</button>
                    </div>
                `;
                
                // Add drag and drop handlers
                taskElement.addEventListener('dragstart', (e) => {
                    draggedElement = taskElement;
                    draggedType = 'task';
                    taskElement.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', task.id);
                });
                
                taskElement.addEventListener('dragend', () => {
                    taskElement.classList.remove('dragging');
                    document.querySelectorAll('.drop-zone').forEach(el => {
                        el.classList.remove('drop-zone');
                    });
                    draggedElement = null;
                    draggedType = null;
                });
                
                // Add tooltip
                taskElement.addEventListener('mouseenter', (e) => showTaskTooltip(e, task));
                taskElement.addEventListener('mouseleave', hideTaskTooltip);
                
                cell.appendChild(taskElement);
            });
            
            // Add drop zones
            document.querySelectorAll('.grid-cell').forEach(cell => {
                cell.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedType === 'task') {
                        cell.classList.add('drop-zone');
                    }
                });
                
                cell.addEventListener('dragleave', () => {
                    cell.classList.remove('drop-zone');
                });
                
                cell.addEventListener('drop', (e) => {
                    e.preventDefault();
                    cell.classList.remove('drop-zone');
                    
                    if (draggedType === 'task' && draggedElement) {
                        const taskId = e.dataTransfer.getData('text/plain');
                        const newCraftsman = cell.dataset.craftsman;
                        const newDay = parseInt(cell.dataset.day);
                        
                        moveTask(taskId, newCraftsman, newDay);
                    }
                });
            });
        }
        
        function createTaskAtCell(craftsmanId, dayNumber) {
            const craftsman = appState.craftsmen.find(c => c.id === craftsmanId);
            if (!craftsman) return;
            
            const taskDate = calculateDateFromDay(dayNumber);
            
            // Reset modal
            document.getElementById('modalTitle').textContent = 'Ny opgave';
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskNotes').value = '';
            document.getElementById('taskStartDate').value = taskDate.toISOString().split('T')[0];
            document.getElementById('taskDuration').value = '1';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskStatus').value = 'planned';
            document.getElementById('taskHalfDay').checked = false;
            document.getElementById('deleteTaskBtn').style.display = 'none';
            
            // Populate craftsman dropdown
            const craftsmanSelect = document.getElementById('taskCraftsman');
            craftsmanSelect.innerHTML = '<option value="">Vælg håndværker...</option>';
            appState.craftsmen.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === craftsmanId) option.selected = true;
                craftsmanSelect.appendChild(option);
            });
            
            currentEditingTask = null;
            document.getElementById('taskModal').classList.add('show');
        }
        
        function editTask(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentEditingTask = task;
            taskBackup = { ...task };
            
            document.getElementById('modalTitle').textContent = 'Redigér opgave';
            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskNotes').value = task.notes || '';
            document.getElementById('taskStartDate').value = task.startDate || '';
            document.getElementById('taskDuration').value = task.duration || 1;
            document.getElementById('taskPriority').value = task.priority || 'medium';
            document.getElementById('taskStatus').value = task.status || 'planned';
            document.getElementById('taskHalfDay').checked = task.isHalfDay || false;
            document.getElementById('deleteTaskBtn').style.display = 'block';
            
            // Populate craftsman dropdown
            const craftsmanSelect = document.getElementById('taskCraftsman');
            craftsmanSelect.innerHTML = '<option value="">Vælg håndværker...</option>';
            appState.craftsmen.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                if (c.id === task.craftsman) option.selected = true;
                craftsmanSelect.appendChild(option);
            });
            
            document.getElementById('taskModal').classList.add('show');
        }
        
        function saveTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const notes = document.getElementById('taskNotes').value.trim();
            const startDate = document.getElementById('taskStartDate').value;
            const duration = parseFloat(document.getElementById('taskDuration').value);
            const craftsman = document.getElementById('taskCraftsman').value;
            const priority = document.getElementById('taskPriority').value;
            const status = document.getElementById('taskStatus').value;
            const isHalfDay = document.getElementById('taskHalfDay').checked;
            
            if (!title || !craftsman || !startDate) {
                showToast('Udfyld titel, håndværker og startdato', 'warning');
                return;
            }
            
            const startDay = calculateDayFromDate(new Date(startDate));
            
            const taskData = {
                title,
                description,
                notes,
                startDate,
                startDay,
                duration,
                craftsman,
                priority,
                status,
                isHalfDay,
                dependencies: []
            };
            
            if (currentEditingTask) {
                Object.assign(currentEditingTask, taskData);
                showToast('✅ Opgave opdateret');
            } else {
                taskData.id = 'task_' + Date.now();
                appState.tasks.push(taskData);
                showToast('✅ Opgave tilføjet');
            }
            
            saveState();
            renderTimeline();
            closeModal('taskModal');
        }
        
        function deleteTask(taskId) {
            if (confirm('Er du sikker på at du vil slette denne opgave?')) {
                appState.tasks = appState.tasks.filter(t => t.id !== taskId);
                saveState();
                renderTimeline();
                showToast('Opgave slettet');
            }
        }
        
        function deleteCurrentTask() {
            if (currentEditingTask && confirm('Er du sikker på at du vil slette denne opgave?')) {
                appState.tasks = appState.tasks.filter(t => t.id !== currentEditingTask.id);
                saveState();
                renderTimeline();
                closeModal('taskModal');
                showToast('Opgave slettet');
            }
        }
        
        function moveTask(taskId, newCraftsmanId, newDay) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.craftsman = newCraftsmanId;
            task.startDay = newDay;
            task.startDate = calculateDateFromDay(newDay).toISOString().split('T')[0];
            
            saveState();
            renderTimeline();
            showToast('Opgave flyttet');
        }
        
        function showTaskTooltip(event, task) {
            const tooltip = document.getElementById('taskTooltip');
            const craftsman = appState.craftsmen.find(c => c.id === task.craftsman);
            
            let content = `<strong>${task.title}</strong><br>`;
            if (task.description) content += `${task.description}<br>`;
            content += `Håndværker: ${craftsman ? craftsman.name : 'Ukendt'}<br>`;
            content += `Varighed: ${task.duration} dag${task.duration !== 1 ? 'e' : ''}<br>`;
            content += `Status: ${{'planned': 'Planlagt', 'in-progress': 'I gang', 'completed': 'Udført'}[task.status]}`;
            if (task.notes) content += `<br>Noter: ${task.notes}`;
            
            tooltip.innerHTML = content;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 10 + 'px';
            
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(() => {
                tooltip.classList.add('show');
            }, 500);
        }
        
        function hideTaskTooltip() {
            const tooltip = document.getElementById('taskTooltip');
            clearTimeout(tooltipTimeout);
            tooltip.classList.remove('show');
        }
        
        function updateTimelineInfo() {
            const projectStart = getProjectStartDate();
            const projectEnd = new Date(projectStart);
            projectEnd.setDate(projectEnd.getDate() + (appState.weeks * 7) - 1);
            
            const startStr = formatDateForInput(projectStart);
            const endStr = formatDateForInput(projectEnd);
            
            if (appState.project.startDate) {
                document.getElementById('timelineInfo').textContent = `Projekt: ${startStr} - ${endStr}`;
            } else {
                document.getElementById('timelineInfo').textContent = 'Projekt: Start dato mangler';
            }
        }
        
        function updateWeekDisplay() {
            document.getElementById('weekDisplay').textContent = `${appState.weeks} uger`;
        }
        
        function updateProjectStartDate() {
            const newStartDate = document.getElementById('projectStartDate').value;
            if (newStartDate) {
                appState.project.startDate = newStartDate;
                
                appState.tasks.forEach(task => {
                    if (task.startDate) {
                        task.startDay = calculateDayFromDate(new Date(task.startDate));
                    }
                });
                
                saveState();
                renderAll();
                updateTimelineInfo();
                showToast('📅 Projekt startdato opdateret');
            }
        }
        
        // PROJECT MODAL FUNCTIONS
        function editProject() {
            document.getElementById('projectName').value = appState.project.name || '';
            document.getElementById('customerName').value = appState.project.customer || '';
            document.getElementById('projectAddress').value = appState.project.address || '';
            document.getElementById('customerPhone').value = appState.project.phone || '';
            document.getElementById('customerEmail').value = appState.project.email || '';
            document.getElementById('startDate').value = appState.project.startDate || '';
            
            document.getElementById('projectModal').classList.add('show');
        }
        
        function saveProject() {
            const oldStartDate = appState.project.startDate;
            
            appState.project.name = document.getElementById('projectName').value;
            appState.project.customer = document.getElementById('customerName').value;
            appState.project.address = document.getElementById('projectAddress').value;
            appState.project.phone = document.getElementById('customerPhone').value;
            appState.project.email = document.getElementById('customerEmail').value;
            appState.project.startDate = document.getElementById('startDate').value;
            
            if (oldStartDate !== appState.project.startDate) {
                appState.tasks.forEach(task => {
                    if (task.startDate) {
                        task.startDay = calculateDayFromDate(new Date(task.startDate));
                    }
                });
                showToast('📅 Projekt startdato ændret - alle opgaver genberegnet!');
            }
            
            saveState();
            renderProjectInfo();
            updateTimelineInfo();
            closeModal('projectModal');
            showToast('✅ Projekt information gemt');
        }
        
        // CRAFTSMAN FUNCTIONS
        function openCraftsmanModal() {
            document.getElementById('craftsmanType').value = '';
            document.getElementById('craftsmanColor').value = '#2196F3';
            document.getElementById('craftsmanModal').classList.add('show');
        }
        
        function saveCraftsman() {
            const type = document.getElementById('craftsmanType').value;
            const color = document.getElementById('craftsmanColor').value;
            
            if (!type) {
                showToast('Vælg en håndværkertype', 'warning');
                return;
            }
            
            const newCraftsman = {
                id: 'craftsman_' + Date.now(),
                name: type,
                color: color,
                order: appState.craftsmen.length
            };
            
            appState.craftsmen.push(newCraftsman);
            saveState();
            renderAll();
            closeModal('craftsmanModal');
            showToast('✅ Håndværker tilføjet');
        }
        
        function deleteCraftsman(craftsmanId) {
            if (confirm('Er du sikker på at du vil slette denne håndværker? Alle tilhørende opgaver vil også blive slettet.')) {
                appState.craftsmen = appState.craftsmen.filter(c => c.id !== craftsmanId);
                appState.tasks = appState.tasks.filter(t => t.craftsman !== craftsmanId);
                
                appState.craftsmen.forEach((c, index) => {
                    c.order = index;
                });
                
                saveState();
                renderAll();
                showToast('Håndværker slettet');
            }
        }
        
        // WEEK FUNCTIONS
        function addWeek() {
            appState.weeks++;
            saveState();
            renderAll();
            updateTimelineInfo();
            showToast('Uge tilføjet');
        }
        
        function removeWeek() {
            if (appState.weeks > 1) {
                appState.weeks--;
                saveState();
                renderAll();
                updateTimelineInfo();
                showToast('Uge fjernet');
            }
        }
        
        // STORAGE FUNCTIONS
        function saveProjectToStorage() {
            try {
                localStorage.setItem('switzeaProject', JSON.stringify(appState));
                showToast('✅ Projekt gemt i localStorage');
            } catch (error) {
                showToast('Fejl ved gem: ' + error.message, 'error');
            }
        }
        
        function loadProjectFromStorage() {
            try {
                const saved = localStorage.getItem('switzeaProject');
                if (saved) {
                    appState = JSON.parse(saved);
                    if (!appState.startWeekNumber) appState.startWeekNumber = 1;
                    
                    saveState();
                    renderAll();
                    updateTimelineInfo();
                    showToast('✅ Projekt indlæst fra localStorage');
                } else {
                    showToast('Ingen gemt projekt fundet', 'warning');
                }
            } catch (error) {
                showToast('Fejl ved indlæsning: ' + error.message, 'error');
            }
        }
        
        // PDF EXPORT FUNCTIONS
        function exportWorkerPDF() {
            if (!appState.project.name || appState.tasks.length === 0) {
                showToast('Tilføj projekt information og opgaver først', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Håndværker PDF - ${appState.project.name}</title>
                    <style>
                        body { font-family: Arial; padding: 20px; line-height: 1.6; }
                        h1 { color: #2E7D32; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
                        .project-info { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
                        .craftsman-section { margin: 30px 0; page-break-before: always; }
                        .craftsman-header { background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
                        .task { margin: 15px 0; padding: 15px; border-left: 5px solid #2196F3; background: #f9f9f9; }
                        .task.high { border-left-color: #f44336; }
                        .task.medium { border-left-color: #ff9800; }
                        .task.low { border-left-color: #4caf50; }
                        .task-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
                        .task-meta { font-size: 0.9em; color: #666; margin-top: 10px; }
                        .footer { margin-top: 40px; text-align: center; color: #666; border-top: 1px solid #ddd; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <h1>🏗️ SWITZEA ApS - Håndværker Arbejdsplan</h1>
                    
                    <div class="project-info">
                        <h2>${appState.project.name}</h2>
                        <p><strong>Kunde:</strong> ${appState.project.customer || 'Ikke angivet'}</p>
                        <p><strong>Adresse:</strong> ${appState.project.address || 'Ikke angivet'}</p>
                        <p><strong>Telefon:</strong> ${appState.project.phone || 'Ikke angivet'}</p>
                        <p><strong>Start:</strong> ${appState.project.startDate || 'Ikke angivet'}</p>
                    </div>
                    
                    ${generateCraftsmanSections()}
                    
                    <div class="footer">
                        <p><strong>SWITZEA ApS</strong> | Professional Projektplanlægning</p>
                        <p>Udskrevet: ${new Date().toLocaleString('da-DK')}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            showToast('📋 Håndværker PDF genereret!');
        }
        
        function generateCraftsmanSections() {
            let html = '';
            appState.craftsmen.forEach(craftsman => {
                const craftsmanTasks = appState.tasks
                    .filter(t => t.craftsman === craftsman.id)
                    .sort((a, b) => a.startDay - b.startDay);
                
                html += `
                    <div class="craftsman-section">
                        <div class="craftsman-header" style="border-left: 6px solid ${craftsman.color};">
                            <h2>${craftsman.name} - ${craftsmanTasks.length} opgave${craftsmanTasks.length !== 1 ? 'r' : ''}</h2>
                        </div>
                        ${craftsmanTasks.map(task => {
                            const statusText = { 'planned': 'Planlagt', 'in-progress': 'I gang', 'completed': 'Udført' }[task.status];
                            const priorityText = { 'high': 'Høj', 'medium': 'Medium', 'low': 'Lav' }[task.priority];
                            
                            return `
                                <div class="task ${task.priority}">
                                    <div class="task-title">${task.title}</div>
                                    ${task.description ? `<p>${task.description}</p>` : ''}
                                    ${task.notes ? `<p><strong>Noter:</strong> ${task.notes}</p>` : ''}
                                    <div class="task-meta">
                                        Dag ${task.startDay} (${task.startDate}) | Status: ${statusText} | Prioritet: ${priorityText} | Varighed: ${task.duration} dag${task.duration !== 1 ? 'e' : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            });
            
            return html;
        }
        
        function exportCustomerPDF() {
            if (!appState.project.name) {
                showToast('Tilføj projekt information først', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const completedTasks = appState.tasks.filter(t => t.status === 'completed').length;
            const totalTasks = appState.tasks.length;
            const progressPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Kunde Rapport - ${appState.project.name}</title>
                    <style>
                        body { font-family: Georgia; padding: 30px; background: #f5f7fa; line-height: 1.6; }
                        .container { background: white; padding: 40px; border-radius: 15px; max-width: 800px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
                        .header { text-align: center; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 40px; border-radius: 15px; margin-bottom: 30px; }
                        h1 { font-size: 3em; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
                        h2 { margin: 10px 0; font-weight: 300; }
                        .greeting { background: linear-gradient(135deg, #f8f9ff, #e3f2fd); padding: 25px; border-radius: 12px; margin-bottom: 25px; border-left: 6px solid #667eea; }
                        .greeting h3 { color: #667eea; margin-top: 0; }
                        .stats { display: flex; justify-content: space-around; margin: 30px 0; }
                        .stat { text-align: center; padding: 20px; }
                        .stat-number { font-size: 2.5em; font-weight: bold; color: #2E7D32; }
                        .stat-label { color: #666; }
                        .progress-bar { background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden; margin: 20px 0; }
                        .progress-fill { background: linear-gradient(90deg, #4CAF50, #45a049); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; transition: width 0.3s ease; }
                        .team { margin: 30px 0; }
                        .team-member { display: inline-block; margin: 5px 10px; padding: 8px 15px; border-radius: 20px; color: white; font-size: 0.9em; }
                        .contact { background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 30px; border-radius: 10px; text-align: center; margin: 30px 0; }
                        .contact h3 { color: #1976d2; margin-bottom: 15px; }
                        .footer { text-align: center; margin-top: 30px; color: #666; border-top: 2px solid #ddd; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>🏗️ SWITZEA ApS</h1>
                            <h2>Projekt Status Rapport</h2>
                            <h3>${appState.project.name}</h3>
                        </div>
                        
                        <div class="greeting">
                            <h3>Kære ${appState.project.customer || 'Kunde'}</h3>
                            <p style="font-size: 1.1em;">Vi er glade for at præsentere status på jeres ${appState.project.name.toLowerCase()}. Projektet forløber planmæssigt, og vi arbejder hver dag for at levere det bedste resultat.</p>
                        </div>
                        
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-number">${progressPercentage}%</div>
                                <div class="stat-label">Færdig</div>
                            </div>
                            <div class="stat">
                                <div class="stat-number">${totalTasks}</div>
                                <div class="stat-label">Opgaver</div>
                            </div>
                            <div class="stat">
                                <div class="stat-number">${appState.craftsmen.length}</div>
                                <div class="stat-label">Specialister</div>
                            </div>
                        </div>
                        
                        <h3 style="color: #2E7D32;">📈 Projekt Fremgang</h3>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%;">
                                ${completedTasks}/${totalTasks} opgaver fuldført
                            </div>
                        </div>
                        
                        <div class="team">
                            <h3 style="color: #2E7D32;">👥 Dit Projekt Team</h3>
                            <p>Vores erfarne specialister arbejder sammen om jeres projekt:</p>
                            <div style="margin-top: 15px;">
                                ${appState.craftsmen.map(c => `<span class="team-member" style="background-color: ${c.color};">${c.name}</span>`).join('')}
                            </div>
                        </div>
                        
                        <div class="contact">
                            <h3>📞 Kontakt os</h3>
                            <p style="margin-bottom: 15px;">Har I spørgsmål eller ønsker opdateringer?</p>
                            <p>📧 kontakt@switzea.dk | 📞 +45 XX XX XX XX</p>
                        </div>
                        
                        <div class="footer">
                            <p><strong>SWITZEA ApS</strong> | Professional Håndværk & Projektledelse</p>
                            <p>Rapport genereret: ${new Date().toLocaleString('da-DK')}</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            showToast('📊 Kunde PDF genereret!');
        }
        
        function exportCompletionReport() {
            if (!appState.project.name) {
                showToast('Tilføj projekt information først', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const completedTasks = appState.tasks.filter(t => t.status === 'completed').length;
            const totalTasks = appState.tasks.length;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Afslutnings Rapport - ${appState.project.name}</title>
                    <style>
                        body { font-family: Georgia; padding: 20px; background: #f8f9fa; line-height: 1.6; }
                        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
                        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 40px; text-align: center; }
                        h1 { font-size: 3em; margin: 0; }
                        h2 { margin: 10px 0; font-weight: 300; }
                        .content { padding: 40px; }
                        .greeting { background: linear-gradient(135deg, #f8f9ff, #e3f2fd); padding: 25px; border-radius: 12px; border-left: 6px solid #667eea; margin-bottom: 25px; }
                        .greeting h3 { color: #667eea; margin-top: 0; }
                        .section { margin-bottom: 30px; }
                        .section h3 { color: #2E7D32; border-bottom: 3px solid #e3f2fd; padding-bottom: 10px; }
                        .checklist { background: linear-gradient(135deg, #e8f5e8, #c8e6c8); padding: 25px; border-radius: 10px; border-left: 6px solid #4CAF50; }
                        .checklist-item { margin: 10px 0; }
                        .checklist-item::before { content: "✅ "; color: #4CAF50; font-weight: bold; }
                        .warranty { background: linear-gradient(135deg, #fff3e0, #ffcc02); padding: 25px; border-radius: 10px; border-left: 6px solid #ff9800; }
                        .contact { background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 30px; border-radius: 10px; text-align: center; }
                        .thank-you { background: linear-gradient(135deg, #e8f5e8, #c8e6c8); padding: 30px; border-radius: 15px; text-align: center; border: 3px solid #4CAF50; }
                        .footer { background: linear-gradient(135deg, #37474f, #263238); color: white; padding: 30px; text-align: center; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>🏗️ SWITZEA ApS</h1>
                            <h2>Projekt Afslutnings Rapport</h2>
                            <h3>${appState.project.name}</h3>
                        </div>
                        
                        <div class="content">
                            <div class="greeting">
                                <h3>Kære ${appState.project.customer || 'Kunde'}</h3>
                                <p style="font-size: 1.1em;">Vi er stolte over at præsentere den komplette dokumentation af jeres ${appState.project.name.toLowerCase()}. Projektet er nu afsluttet med stor succes, og vi er glade for at have været en del af jeres rejse.</p>
                            </div>
                            
                            <div class="section">
                                <h3>📊 Projekt Sammenfatning</h3>
                                <ul style="margin: 20px 0; line-height: 2;">
                                    <li><strong>Opgaver i alt:</strong> ${totalTasks}</li>
                                    <li><strong>Fuldførte opgaver:</strong> ${completedTasks}</li>
                                    <li><strong>Team størrelse:</strong> ${appState.craftsmen.length} specialister</li>
                                    <li><strong>Projekt varighed:</strong> ${appState.weeks} uger</li>
                                    <li><strong>Projekt status:</strong> Afsluttet ✅</li>
                                </ul>
                            </div>
                            
                            <div class="section">
                                <h3>✅ Kvalitetssikring</h3>
                                <div class="checklist">
                                    <div class="checklist-item">Alle materialer leveret efter specifikationer og certificeret</div>
                                    <div class="checklist-item">Arbejde udført efter gældende byggeregler og standarder</div>
                                    <div class="checklist-item">Kvalitetskontrol gennemført på alle opgaver</div>
                                    <div class="checklist-item">Arbejdsplads ryddet og professionelt rengjort</div>
                                    <div class="checklist-item">Komplet dokumentation og garantibeviser overdraget</div>
                                </div>
                            </div>
                            
                            <div class="section">
                                <h3>🛡️ Garanti & Service</h3>
                                <div class="warranty">
                                    <ul style="margin: 0; line-height: 1.8;">
                                        <li><strong>Arbejdsgaranti:</strong> 2 år på alt håndværkerarbejde udført af SWITZEA</li>
                                        <li><strong>Materialgaranti:</strong> Efter producentens specifikationer (typisk 5-10 år)</li>
                                        <li><strong>Service:</strong> Gratis eftersyn efter 6 måneder og ved 18 måneder</li>
                                        <li><strong>Support:</strong> Telefon- og emailsupport i hele garantiperioden</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="section">
                                <h3>📞 Fremtidig Kontakt</h3>
                                <div class="contact">
                                    <h4 style="color: #1976d2;">Vi er altid her for jer!</h4>
                                    <p style="margin-bottom: 20px;">Har I spørgsmål eller brug for assistance i fremtiden, så tøv ikke med at kontakte os.</p>
                                    <p>📧 kontakt@switzea.dk | 📞 +45 XX XX XX XX | 🌐 www.switzea.dk</p>
                                </div>
                            </div>
                            
                            <div class="thank-you">
                                <h2 style="color: #2e7d32; margin-bottom: 15px;">🙏 Tak for jeres tillid!</h2>
                                <p style="font-size: 1.1em; color: #388e3c;">Det har været en fornøjelse at arbejde med jer på dette projekt. Vi håber I får mange års glæde af det færdige resultat!</p>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <h3 style="margin: 0 0 10px 0;">🏗️ SWITZEA ApS</h3>
                            <p style="opacity: 0.9; margin-bottom: 20px; font-style: italic;">Professional Håndværk • Pålidelig Service • Kvalitet i Focus</p>
                            <p style="font-size: 0.9em; opacity: 0.8; margin: 0;">Afslutnings rapport genereret: ${new Date().toLocaleString('da-DK')}</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            showToast('🏁 Komplet afslutnings rapport genereret!');
        }
        
        // UTILITY FUNCTIONS
        function closeModal(modalId) {
            if (modalId === 'taskModal' && taskBackup && currentEditingTask) {
                Object.assign(currentEditingTask, taskBackup);
                renderTimeline();
                showToast('🔄 Ændringer annulleret', 'info');
                taskBackup = null;
            }
            
            document.getElementById(modalId).classList.remove('show');
            currentEditingTask = null;
            
            if (modalId === 'importModal') {
                importData = null;
                document.getElementById('csvPreview').style.display = 'none';
                document.getElementById('importBtn').disabled = true;
                document.getElementById('csvFileInput').value = '';
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }
        
        // Global error handling
        window.addEventListener('error', (e) => {
            console.error('JavaScript error:', e.message);
            showToast('Der opstod en fejl - prøv igen', 'error');
        });
        
        // Prevent accidental navigation
        window.addEventListener('beforeunload', (e) => {
            if (appState.tasks.length > 0 || appState.craftsmen.length > 0) {
                e.preventDefault();
                e.returnValue = '';
                return 'Er du sikker på du vil forlade appen uden at gemme?';
            }
        });
        
        // Hide tooltip when scrolling
        window.addEventListener('scroll', hideTaskTooltip);
    </script>
</body>
</html>
