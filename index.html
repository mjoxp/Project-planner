<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Switzea Projektstyring - Timeline & PDF</title>
<style>
/* Reset og basal styling */
html, body {margin:0;padding:0; box-sizing: border-box; font-family: Arial, sans-serif; background:#f5f7fa;}
button {cursor:pointer; font-family: inherit; outline:none;}
/* Header Banners */
.company-banner {
  background: linear-gradient(135deg,#2E7D32,#4CAF50);
  color:#fff;
  text-align:center; padding:15px; font-weight:600; font-size:1.2em; box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.header {background:#333; color:#fff; padding:1rem; display:flex; flex-wrap:wrap; align-items: center; gap:1rem;}
.header h1 {margin:0; font-size:1.5rem;}
.header .project-info {flex:1; font-size:1rem;}
.header .buttons {display:flex; gap:0.75rem; flex-wrap:wrap;}
.btn {padding:0.75rem 1.3rem; border:none; border-radius:8px; font-weight:600; font-family:inherit; transition:all 0.2s; font-size:0.95rem;}
.btn:hover {transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,0.2);}
.btn-primary {background:#4CAF50; color:#fff;}
.btn-secondary {background:#2196F3; color:#fff;}
.btn-outline {background:transparent; border:2px solid #fff; color:#fff;}
.btn-danger {background:#f44336; color:#fff;}
.btn-success {background:#28a745; color:#fff;}
.btn-completion {background: linear-gradient(135deg,#ff6b35,#f7931e); color:#fff;}
/* Main layout */
#main {display:flex; flex-wrap:wrap; gap:2rem; padding:1rem; max-width:1500px; margin:auto;}
#sidebar {flex:0 0 320px; background:#fff; border-radius:12px; padding:1rem; box-shadow:0 4px 20px rgba(0,0,0,0.1);}
#timeline {flex:1; min-width:600px; display:flex; flex-direction:column; gap:1rem;}
/* Timeline header */
.timeline-header {display:flex; background:#e0e0e0; border-radius:8px; font-weight:600; font-size:0.95rem; padding:0.5rem;}
.header-craftsman {width:200px; padding:0.75rem; display:flex; align-items:center; justify-content:center;}
.header-days {flex:1; display:flex; font-weight:600;}
.day {flex:1; padding:0.5rem; text-align:center; border-right:1px solid #ccc; font-size:0.85rem; background:#f0f0f0;}
.day:last-child {border-right:none;}
/* Timeline grid */
#grid {overflow-x:auto; background:#fff; border-radius:8px; padding-bottom:1rem; border:1px solid #ccc;}
.grid-body {display:flex; flex-direction:column;}
.grid-row {display:flex; min-height:80px; border-bottom:1px solid #eee; position:relative;}
.grid-row:nth-child(even) {background:#fafafa;}
.craftsman-cell {width:200px; padding:0.75rem; font-weight:600; display:flex; align-items:center;}
.cell {flex:1; border-right:1px solid #ccc; position:relative; min-width:50px; cursor: pointer;}
.cell:last-child {border-right:none;}
.task {
  position:absolute; background:#2196F3; border-radius:6px; color:#fff; padding:0.2rem 0.4rem; font-size:0.75rem; line-height:1.2; cursor:grab; max-height:60px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; transition:all 0.2s; border:2px solid transparent;
}
.task.high {border-left:6px solid #f44336; background:#e53935;}
.task.medium {border-left:6px solid #ff9800; background:#fb8c00;}
.task.low {border-left:6px solid #4caf50; background:#43a047;}
.task.in-progress {background:#2196F3;}
.task.completed {background:#4CAF50;}
.task.half-day {height:40px; font-size:0.7rem;}
.task:hover {transform:scale(1.02); z-index:10;}
/* Tooltip for task title */
.task-tooltip {
  position:absolute; background:rgba(0,0,0,0.9); color:#fff; padding:0.75rem; border-radius:6px; font-size:0.85rem; max-width:300px; white-space:pre-wrap; word-wrap:break-word; z-index:500; display:none;
}
.task:hover .task-tooltip {display:block;}
/* Buttons and modal styling */
#modal {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000;}
#modal .modal-content {background:#fff; padding:1.5rem; border-radius:12px; max-width:600px; width:90%; max-height:90%; overflow-y:auto; position:relative;}
#modal h2 {margin-top:0;}
.close-btn {position:absolute; top:10px; right:15px; background:none; border:none; font-size:1.5rem; cursor:pointer;}
/* PDF buttons style */
.pdf-buttons {display:flex; gap:0.75rem; flex-wrap:wrap;}
/* Responsive adjustments */
@media(max-width: 768px) {
  #main {flex-direction:column;}
  #sidebar {flex:1; width:100%;}
  #timeline {width:100%;}
}
</style>
</head>
<body>

<div class="company-banner">üèóÔ∏è SWITZEA ApS - Projektstyringssystem</div>

<div class="header">
  <h1>Projektstyring - Timeline & PDF</h1>
  <div class="project-info" id="projectInfo">Ingen projekt oprettet endnu.</div>
  <div class="buttons">
    <button class="btn btn-primary" id="btnEditProject">üìù Redig√©r Projekt</button>
    <button class="btn btn-secondary" id="btnSave">üíæ Gem Projekt</button>
    <button class="btn btn-secondary" id="btnLoad">üìÇ Indl√¶s Projekt</button>
    <button class="btn btn-success" id="btnH√•ndv√¶rkerPDF">üìã H√•ndv√¶rker PDF</button>
    <button class="btn btn-success" id="btnKundePDF">üìä Kunde PDF</button>
    <button class="btn btn-success" id="btnF√¶rdigg√∏r">üèÅ Afslutningsrapport</button>
  </div>
</div>

<div id="main">
  <div id="sidebar">
    <h3>H√•ndv√¶rkere</h3>
    <button class="btn btn-outline" id="btnAddCraftsman">+ Tilf√∏j H√•ndv√¶rker</button>
    <ul id="craftsmanList" class="craftsman-list"></ul>
    <hr/>
    <div>
      <label for="weeksToShow">Antal uger: </label>
      <input type="number" id="weeksToShow" min="1" max="10" value="3"/>
      <button class="btn btn-outline" id="btnUpdateWeeks">Opdater</button>
    </div>
    <div style="margin-top:10px;">
      <label for="startDate">Startdato: </label>
      <input type="date" id="startDate"/>
    </div>
  </div>
  <div id="timeline">
    <div class="section-title"><span>üóìÔ∏è Timeline</span></div>
    <div class="timeline-header" id="timelineHeader"></div>
    <div class="grid-body" id="grid"></div>
  </div>
</div>

<!-- Modal til projektoplysninger -->
<div id="projectModal" style="display:none;">
  <div class="modal-content">
    <button class="close-btn" id="closeProject">&times;</button>
    <h2>Redig√©r Projekt</h2>
    <label>Projektnavn: <input type="text" id="inputProjectName"/></label><br/><br/>
    <label>Kunde: <input type="text" id="inputCustomer"/></label><br/><br/>
    <label>Adresse: <input type="text" id="inputAddress"/></label><br/><br/>
    <label>Telefon: <input type="text" id="inputPhone"/></label><br/><br/>
    <label>Startdato: <input type="date" id="inputStartDate"/></label><br/><br/>
    <button class="btn btn-primary" id="btnSaveProject">Gem</button>
  </div>
</div>

<!-- Modal til tilf√∏j/rediger opgave -->
<div id="taskModal" style="display:none;">
  <div class="modal-content">
    <button class="close-btn" id="closeTask">&times;</button>
    <h2>Opret/Rediger Opgave</h2>
    <form id="formTask">
      <label>Titel: <input type="text" id="taskTitle" required/></label><br/><br/>
      <label>Beskrivelse: <textarea id="taskDesc" rows="3"></textarea></label><br/><br/>
      <label>H√•ndv√¶rker: <select id="selectCraftsman" required></select></label><br/><br/>
      <label>Prioritet:
        <select id="selectPriority">
          <option value="high">H√∏j</option>
          <option value="medium">Medium</option>
          <option value="low" selected>Lav</option>
        </select>
      </label><br/><br/>
      <label>Status:
        <select id="selectStatus">
          <option value="planned">Planlagt</option>
          <option value="in-progress">I gang</option>
          <option value="completed">F√¶rdig</option>
        </select>
      </label><br/><br/>
      <label>Varighed (dage): <input type="number" id="taskDuration" min="1" required/></label><br/><br/>
      <label>Startdato: <input type="date" id="taskStartDate" required/></label><br/><br/>
      <input type="hidden" id="taskId"/>
      <button class="btn btn-primary" type="submit">Gem Opgave</button>
    </form>
  </div>
</div>

<!-- PDF preview modal -->
<div id="pdfModal" style="display:none; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; position:fixed; z-index:2000;">
  <div style="background:#fff; padding:1rem; border-radius:12px; max-width:90%; max-height:90%; overflow:auto; position:relative;">
    <button style="position:absolute; top:10px; right:15px; font-size:1.5rem; background:none; border:none; cursor:pointer;" id="closePdf">&times;</button>
    <iframe src="" style="width:100%; height:80vh; border:none;" id="pdfFrame"></iframe>
  </div>
</div>

<!-- Tooltip for task hover -->
<div class="task-tooltip" id="tooltip"></div>

<script>
/* JavaScript for funktionaliteter */

const project = {name:'', customer:'', address:'', phone:'', startDate:''};
let craftsmen = [];
let tasks = [];
let weeksToShow = 3;
const startDateInput = document.getElementById('startDate');

const projectInfoDiv = document.getElementById('projectInfo');

function init() {
  document.getElementById('btnEditProject').onclick = openProjectModal;
  document.getElementById('closeProject').onclick = closeProjectModal;
  document.getElementById('btnSaveProject').onclick = saveProject;
  document.getElementById('btnAddCraftsman').onclick = addCraftsman;
  document.getElementById('btnUpdateWeeks').onclick = updateWeeks;
  document.getElementById('btnF√¶rdigg√∏r').onclick = generateF√¶rdigg√∏relsesRapport;
  document.getElementById('closePdf').onclick = () => { document.getElementById('pdfModal').style.display='none'; };
  document.getElementById('btnH√•ndv√¶rkerPDF').onclick = () => generateH√•ndv√¶rkerPDF();
  document.getElementById('btnKundePDF').onclick = () => generateKundePDF();
  document.getElementById('btnF√¶rdigg√∏r').onclick = () => generateF√¶rdigg√∏relsesRapport();

  document.getElementById('formTask').onsubmit = saveTask;
  document.getElementById('closeTask').onclick = () => { document.getElementById('taskModal').style.display='none'; };
  document.getElementById('btnSave').onclick = saveProjectToLocal;
  document.getElementById('btnLoad').onclick = loadProjectFromLocal;

  document.getElementById('btnUpdateWeeks').onclick = () => {
    weeksToShow=parseInt(document.getElementById('weeksToShow').value);
    renderTimeline();
  };

  // Initial startdato
  if (!project.startDate) {
    const todayStr = new Date().toISOString().slice(0,10);
    document.getElementById('startDate').value = todayStr;
  }
  updateProjectInfo();

  // Eventlistener for startdato
  startDateInput.onchange = () => { updateProjectStartDate(); renderTimeline(); };

  loadFromLocal();

  renderCraftsmen();
  renderTimeline();
}

function updateProjectStartDate() {
  const val = document.getElementById('startDate').value;
  project.startDate = val;
  updateProjectInfo();
}

function updateProjectInfo() {
  projectInfoDiv.innerHTML = project.name ? 
    `Projekt: ${project.name} | Kunde: ${project.customer} | Adresse: ${project.address} | Startdato: ${project.startDate}` :
    'Ingen projekt oprettet endnu.';
}

function openProjectModal() {
  document.getElementById('projectModal').style.display='flex';
  document.getElementById('inputProjectName').value = project.name;
  document.getElementById('inputCustomer').value = project.customer;
  document.getElementById('inputAddress').value = project.address;
  document.getElementById('inputPhone').value = project.phone;
  document.getElementById('inputStartDate').value = project.startDate || new Date().toISOString().slice(0,10);
}
function closeProjectModal() {
  document.getElementById('projectModal').style.display='none';
}
function saveProject() {
  project.name=document.getElementById('inputProjectName').value;
  project.customer=document.getElementById('inputCustomer').value;
  project.address=document.getElementById('inputAddress').value;
  project.phone=document.getElementById('inputPhone').value;
  project.startDate=document.getElementById('inputStartDate').value;
  updateProjectInfo();
  closeProjectModal();
  renderTimeline();
}

function addCraftsman() {
  const name = prompt("H√•ndv√¶rker navn");
  if (!name) return;
  const color = prompt("Farve (f.eks. #2196F3 eller navn)");
  const id = Date.now();
  const newCraftsman = {id, name, color: color || getRandomColor()};
  craftsmen.push(newCraftsman);
  renderCraftsmen();
  renderTimeline();
}
function getRandomColor() {
  const colors = ['#2196F3','#4CAF50','#f44336','#ff9800','#673AB7','#00bcd4'];
  return colors[Math.floor(Math.random()*colors.length)];
}
function renderCraftsmen() {
  const list = document.getElementById('craftsmanList');
  list.innerHTML='';
  craftsmen.forEach(c => {
    const li=document.createElement('li');
    li.className='craftsman-item';
    li.style.borderLeft=`6px solid ${c.color}`;
    li.innerHTML=`<div>${c.name}</div><button class="delete-btn" onclick="deleteCraftsman(${c.id})">&times;</button>`;
    li.draggable='true';
    li.ondragstart = e => { e.dataTransfer.setData('text/plain', c.id); };
    list.appendChild(li);
  });
}
function deleteCraftsman(id) {
  craftsmen = craftsmen.filter(c=>c.id!==id);
  renderCraftsmen();
  renderTimeline();
}

// Timeline rendering
function renderTimeline() {
  const container=document.getElementById('timelineHeader');
  const grid=document.getElementById('grid');
  container.innerHTML='';
  grid.innerHTML='';

  if (!project.startDate) return;

  const start = new Date(project.startDate);
  // build header: uger x
  const weeksTemp = [];
  for (let i=0; i<weeksToShow; i++) {
    let weekStart = new Date(start);
    weekStart.setDate(start.getDate() + i*7);
    let weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate()+6);
    weeksTemp.push({start: weekStart, end: weekEnd});
  }

  // Header row: h√•ndv√¶rkere + dage
  let headerRow = document.createElement('div');
  headerRow.className='grid-header';

  // H√•ndv√¶rkere
  let craftHeader = document.createElement('div');
  craftHeader.className='header-craftsman';
  craftHeader.innerHTML='H√•ndv√¶rkere';
  headerRow.appendChild(craftHeader);

  // Dage
  const allDays = [];
  weeksTemp.forEach(week=>{
    for(let d=0; d<7; d++) {
      const date = new Date(week.start);
      date.setDate(week.start.getDate()+d);
      allDays.push({date, weekStart:week.start});
    }
  });

  // Build dagoversigt
  // Uge-sektions header
  const weekSections={};
  weeksTemp.forEach((w,i)=>{
    const weekDiv=document.createElement('div');
    weekDiv.className='week-section';
    const header=document.createElement('div');
    header.className='week-header';
    header.innerText=`Uge ${getWeekNumber(w.start)}`;
    const range=document.createElement('div');
    range.className='week-date-range';
    range.innerText=`${formatDate(w.start)} - ${formatDate(w.end)}`;
    header.appendChild(range);
    weekDiv.appendChild(header);
    container.appendChild(weekDiv);
    weekSections[w.start.getTime()]=weekDiv;
  });

  // Dage
  allDays.forEach(day => {
    const dayDiv = document.createElement('div');
    dayDiv.className='day';
    if (day.date.getDay()===0 || day.date.getDay()===6) dayDiv.classList.add('weekend');
    if (isToday(day.date)) dayDiv.classList.add('today');
    dayDiv.innerHTML=`<div class="day-name">${formatDayName(day.date)}</div><div class="day-date">${formatDate(day.date)}</div>`;
    // Find tilh√∏rende uge
    const weekStartTime=day.weekStart.getTime();
    weekSections[weekStartTime]?.appendChild(dayDiv);
    dayDiv.dataset.date=day.date.toISOString().slice(0,10);
    dayDiv.dataset.weekStart=day.weekStart.getTime();
  });

  // Opgaver
  // For hver h√•ndv√¶rker, vis funktion
  craftsmen.forEach(c => {
    // For hver dag
    allDays.forEach(day=>{
      const cell = createGridCell(c, day);
      document.querySelector(`.week-section[data-start="${day.weekStart}"]`)?.appendChild(cell);
    });
  });
}

// Utility
function getWeekNumber(d) {
  const date = new Date(d);
  date.setHours(0,0,0,0);
  date.setDate(date.getDate() + 3 - (date.getDay()||7));
  const week1 = new Date(date.getFullYear(),0,4);
  return Math.ceil((((date - week1)/(86400*1000)+1)/7));
}
function formatDate(d) {
  const date=new Date(d);
  return date.toLocaleDateString('da-DK');
}
function formatDayName(d) {
  return d.toLocaleDateString('da-DK',{weekday:'long'});
}
function isToday(d) {
  const today=new Date();
  return d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth() && d.getDate()===today.getDate();
}

// Create task grid cell
function createGridCell(craftsman, day) {
  const cell=document.createElement('div');
  cell.className='grid-cell';
  cell.dataset.craftsmanId=craftsman.id;
  cell.dataset.date=day.date.toISOString().slice(0,10);
  cell.ondragover=e=>{e.preventDefault(); e.currentTarget.classList.add('drop-zone');}
  cell.ondragleave=e=>{ e.currentTarget.classList.remove('drop-zone');}
  cell.ondrop=e=>{
    e.preventDefault(); e.currentTarget.classList.remove('drop-zone');
    const taskId=e.dataTransfer.getData('taskId');
    moveTaskTo(cell, taskId);
  };
  return cell;
}

// Tasks
function addTask(craftsmanId, dateStr, taskData) {
  const task={id: 'task_'+Date.now(), ...taskData, craftsmanId, date:dateStr};
  tasks.push(task);
  renderTasks();
}
function renderTasks() {
  document.querySelectorAll('.task').forEach(t=>t.remove());
  tasks.forEach(task => {
    const cell=document.querySelector(`.grid-cell[data-craftsman-id="${task.craftsmanId}"][data-date="${task.date}"]`);
    if (!cell) return;
    const div=document.createElement('div');
    div.className='task '+task.priority+' '+task.status+' '+(task.halfDay?'half-day':'');
    div.draggable=true;
    div.dataset.taskId=task.id;
    div.innerText=task.title;
    // Tooltip
    const tooltip=document.createElement('div');
    tooltip.className='task-tooltip';
    tooltip.innerText=task.title + '\\n' + (task.desc||'');
    div.appendChild(tooltip);
    div.onclick=()=>editTask(task.id);
    div.ondragstart=e => {
      e.dataTransfer.setData('taskId', task.id);
      setTimeout(()=>div.classList.add('dragging'), 0);
    };
    div.ondragend=()=>div.classList.remove('dragging');
    // Position
    const rect=div.getBoundingClientRect();
    div.style.top='10px';
    div.style.left='2px';
    cell.appendChild(div);
  });
}

// Move task to another cell
function moveTaskTo(cell, taskId) {
  const task = tasks.find(t=>t.id===taskId);
  if(!task) return;
  task.craftsmanId=cell.dataset.craftsmanId;
  task.date=cell.dataset.date;
  renderTasks();
}

function editTask(taskId) {
  const task = tasks.find(t=>t.id===taskId);
  if (!task) return;
  // fill modal
  document.getElementById('taskTitle').value=task.title;
  document.getElementById('taskDesc').value=task.desc||'';
  document.getElementById('selectPriority').value=task.priority;
  document.getElementById('selectStatus').value=task.status;
  document.getElementById('taskDuration').value=task.duration;
  document.getElementById('taskStartDate').value=task.date;
  document.getElementById('taskId').value=task.id;
  // fill Craftsman
  let options='';
  craftsmen.forEach(c => {
    options+=`<option value="${c.id}" ${c.id==task.craftsmanId?'selected':''}>${c.name}</option>`;
  });
  document.getElementById('selectCraftsman').innerHTML=options;
  document.getElementById('taskModal').style.display='flex';
}
function saveTask(e) {
  e.preventDefault();
  const id=document.getElementById('taskId').value;
  const title=document.getElementById('taskTitle').value;
  const desc=document.getElementById('taskDesc').value;
  const craftsmanId=document.getElementById('selectCraftsman').value;
  const priority=document.getElementById('selectPriority').value;
  const status=document.getElementById('selectStatus').value;
  const duration=parseInt(document.getElementById('taskDuration').value);
  const date=document.getElementById('taskStartDate').value;
  if (id) {
    const task=tasks.find(t=>t.id===id);
    if (task) {
      task.title=title;
      task.desc=desc;
      task.craftsmanId=craftsmanId;
      task.priority=priority;
      task.status=status;
      task.duration=duration;
      task.date=date;
    }
  } else {
    tasks.push({id:'task_'+Date.now(), title, desc, craftsmanId, priority, status, duration, date});
  }
  renderTasks();
  document.getElementById('taskModal').style.display='none';
}

function generateH√•ndv√¶rkerPDF() {
  alert('H√•ndv√¶rker PDF genereres...');
  const pdfContent=`<h1>H√•ndv√¶rker Plan</h1><p>Der vil v√¶re en detaljeret arbejdsplan for h√•ndv√¶rkere.</p>`;
  showPdfPreview(pdfContent);
}
function generateKundePDF() {
  alert('Kunde PDF genereres...');
  const pdfContent=`<h1>Kunde Projekt Status</h1><p>Her vises projektstatus og milep√¶le.</p>`;
  showPdfPreview(pdfContent);
}
function generateF√¶rdigg√∏relsesRapport() {
  alert('Afslutnings rapport genereres...');
  const pdfContent=`<h1>Projekt Afslutning</h1><p>Her er sidste status, fotos, og kundetilfredshed.</p>`;
  showPdfPreview(pdfContent);
}
function showPdfPreview(htmlContent) {
  const iframe=document.getElementById('pdfFrame');
  document.getElementById('pdfModal').style.display='flex';
  iframe.src='data:text/html;charset=utf-8,'+encodeURIComponent(htmlContent);
}
document.getElementById('closePdf').onclick=()=>{ document.getElementById('pdfModal').style.display='none'; };

// Save/load local
function saveProjectToLocal() {
  localStorage.setItem('switzea_project', JSON.stringify({project, craftsmen, tasks}));
  alert('Projekt gemt!');
}
function loadProjectFromLocal() {
  const data=localStorage.getItem('switzea_project');
  if (data) {
    const obj=JSON.parse(data);
    Object.assign(project, obj.project);
    craftsmen=obj.craftsmen;
    tasks=obj.tasks;
    updateProjectInfo();
    renderCraftsmen();
    renderTimeline();
  }
}
function loadFromLocal() {
  loadProjectFromLocal();
  document.getElementById('startDate').value=project.startDate||new Date().toISOString().slice(0,10);
}

// Utility
function getWeekNumber(d) {
  const date=new Date(d); date.setHours(0,0,0,0); date.setDate(date.getDate() + 3 - (date.getDay()||7));
  const firstWeek=new Date(date.getFullYear(),0,4);
  return Math.ceil((((date - firstWeek)/(86400*1000)+1)/7));
}
function formatDate(d) {
  return new Date(d).toLocaleDateString('da-DK');
}
function formatDayName(d) {
  return new Date(d).toLocaleDateString('da-DK',{weekday:'long'});
}
function isToday(d) {
  const today=new Date(); return d.getFullYear()===today.getFullYear() && d.getMonth()===today.getMonth() && d.getDate()===today.getDate();
}

// Initial
init();
</script>
</body>
</html>
