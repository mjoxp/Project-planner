<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switzea Projektplanl√¶gning</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f5f7fa;
            overflow-x: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
        .header .project-info { font-size: 0.9rem; opacity: 0.9; }
        
        .header-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-outline { background: transparent; color: white; border: 1px solid white; }
        .btn-danger { background: #f44336; color: white; }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .main-container {
            display: flex;
            height: calc(100vh - 100px);
        }
        
        /* Sidebar - ONLY H√ÖNDV√ÜRKERE */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 2px solid #e0e0e0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        .sidebar h3 {
            margin-bottom: 1rem;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.2rem;
        }
        
        .craftsman-list {
            list-style: none;
            flex: 1;
        }
        
        .craftsman-item {
            padding: 1rem;
            margin: 0.5rem 0;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            border-left: 6px solid;
            cursor: grab;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .craftsman-item:hover { 
            background: linear-gradient(145deg, #e9ecef, #dee2e6);
            transform: translateX(5px) scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .craftsman-item.dragging { opacity: 0.5; transform: rotate(2deg); }
        
        .delete-craftsman {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .delete-craftsman:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .timeline-container {
            flex: 1;
            padding: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .week-controls {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Timeline Grid - CLEAN SEPARATION */
        .timeline-grid {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .grid-header {
            display: flex;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-bottom: 3px solid #dee2e6;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            min-height: 70px;
        }
        
        .header-craftsman {
            min-width: 200px;
            max-width: 200px;
            padding: 1rem;
            border-right: 3px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #e9ecef, #d6d8db);
            font-size: 1.1rem;
            color: #495057;
            font-weight: 600;
        }
        
        .header-days {
            flex: 1;
            display: flex;
        }
        
        .day-header {
            flex: 1;
            padding: 0.75rem 0.5rem;
            border-right: 1px solid #dee2e6;
            text-align: center;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            font-size: 0.85rem;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
        }
        
        .day-header:last-child { border-right: none; }
        
        .grid-body {
            flex: 1;
            overflow-y: auto;
        }
        
        .grid-row {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            min-height: 80px;
            position: relative;
        }
        
        .grid-row:nth-child(even) { background: #fafbfc; }
        
        .row-craftsman {
            min-width: 200px;
            max-width: 200px;
            padding: 1rem;
            border-right: 3px solid #dee2e6;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            font-weight: 600;
            display: flex;
            align-items: center;
            border-left: 6px solid;
            position: sticky;
            left: 0;
            z-index: 5;
            box-shadow: 2px 0 3px rgba(0,0,0,0.1);
        }
        
        .row-days {
            flex: 1;
            display: flex;
            position: relative;
        }
        
        .grid-cell {
            flex: 1;
            border-right: 1px solid #dee2e6;
            position: relative;
            transition: all 0.2s;
            min-height: 80px;
        }
        
        .grid-cell:last-child { border-right: none; }
        .grid-cell:hover { background: #e3f2fd; }
        .grid-cell.drop-zone { background: #c8e6c9 !important; }
        
        /* Tasks - Enhanced styling */
        .task {
            position: absolute;
            background: linear-gradient(145deg, #2196F3, #1976D2);
            color: white;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: move;
            font-size: 0.8rem;
            line-height: 1.2;
            z-index: 3;
            transition: all 0.2s;
            border: 2px solid transparent;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            top: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        
        .task:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        }
        
        .task.dragging {
            opacity: 0.8;
            transform: rotate(3deg) scale(1.05);
            z-index: 100;
        }
        
        .task.high { 
            border-left: 6px solid #f44336; 
            background: linear-gradient(145deg, #e53935, #c62828);
        }
        .task.medium { 
            border-left: 6px solid #ff9800; 
            background: linear-gradient(145deg, #fb8c00, #ef6c00);
        }
        .task.low { 
            border-left: 6px solid #4caf50; 
            background: linear-gradient(145deg, #43a047, #388e3c);
        }
        
        .task.planned { background: linear-gradient(145deg, #6c757d, #5a6268); }
        .task.in-progress { background: linear-gradient(145deg, #2196F3, #1976D2); }
        .task.completed { background: linear-gradient(145deg, #4CAF50, #388E3C); }
        
        .task.half-day {
            min-height: 35px !important;
            font-size: 0.7rem;
            padding: 0.25rem;
        }
        
        .task-title {
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }
        
        .task-controls {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.25rem;
        }
        
        .task-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 3px 7px;
            border-radius: 3px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .task-btn:hover { background: rgba(255,255,255,0.4); }
        
        /* Enhanced Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 500px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.2s;
        }
        
        .modal.show .modal-content { transform: scale(1); }
        
        .modal h3 {
            margin-bottom: 1.5rem;
            color: #333;
            font-size: 1.3rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
        }
        
        .form-row .form-group { flex: 1; }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 500;
        }
        
        .toast.show { transform: translateX(0); }
        .toast.error { background: #f44336; }
        .toast.warning { background: #ff9800; }
        
        /* Loading state */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #666;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
                max-height: 200px;
                overflow-y: auto;
            }
            
            .header-craftsman, .row-craftsman {
                min-width: 150px;
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1 id="projectTitle">Capellas All√© 38 Renovering</h1>
            <div class="project-info">
                <span id="projectAddress">Capellas All√© 38, 2770 Kastrup</span> ‚Ä¢ 
                <span id="projectCustomer">Maria Josefina Herrera og Jose Eduardo Gran</span>
            </div>
        </div>
        <div class="header-buttons">
            <button class="btn btn-secondary" id="undoBtn">‚Ü∫ Fortryd</button>
            <button class="btn btn-secondary" id="redoBtn">‚Üª Gendan</button>
            <button class="btn btn-primary" id="saveBtn">üíæ Gem</button>
            <button class="btn btn-secondary" id="loadBtn">üìÇ Indl√¶s</button>
            <button class="btn btn-outline" id="pdfBtn">üìÑ PDF</button>
            <button class="btn btn-outline" id="customerViewBtn">üë• Kunde</button>
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <h3>
                H√•ndv√¶rkere 
                <button class="btn btn-primary" id="addCraftsmanBtn">+ Tilf√∏j</button>
            </h3>
            <ul class="craftsman-list" id="craftsmanList">
                <div class="loading">Indl√¶ser h√•ndv√¶rkere...</div>
            </ul>
        </div>

        <div class="timeline-container">
            <div class="week-controls">
                <button class="btn btn-secondary" id="removeWeekBtn">‚àí Fjern uge</button>
                <span id="weekDisplay">3 uger</span>
                <button class="btn btn-secondary" id="addWeekBtn">+ Tilf√∏j uge</button>
            </div>
            
            <div class="timeline-grid" id="timelineGrid">
                <div class="loading">Indl√¶ser projekt...</div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h3 id="modalTitle">Ny opgave</h3>
            <form id="taskForm">
                <div class="form-group">
                    <label for="taskTitle">Opgavetitel</label>
                    <input type="text" class="form-control" id="taskTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="taskDescription">Beskrivelse</label>
                    <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskCraftsman">H√•ndv√¶rker</label>
                        <select class="form-control" id="taskCraftsman" required></select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskPriority">Prioritet</label>
                        <select class="form-control" id="taskPriority">
                            <option value="low">Lav</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">H√∏j</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskStatus">Status</label>
                        <select class="form-control" id="taskStatus">
                            <option value="planned" selected>Planlagt</option>
                            <option value="in-progress">I gang</option>
                            <option value="completed">Udf√∏rt</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDuration">Varighed (dage)</label>
                        <input type="number" class="form-control" id="taskDuration" min="0.5" step="0.5" value="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="taskHalfDay">
                        <label for="taskHalfDay">Halv dag opgave</label>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-danger" id="deleteTaskBtn" style="display: none;">Slet opgave</button>
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Annull√©r</button>
                    <button type="submit" class="btn btn-primary">Gem opgave</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Craftsman Modal -->
    <div class="modal" id="craftsmanModal">
        <div class="modal-content">
            <h3>Tilf√∏j h√•ndv√¶rker</h3>
            <form id="craftsmanForm">
                <div class="form-group">
                    <label for="craftsmanName">Navn</label>
                    <input type="text" class="form-control" id="craftsmanName" required>
                </div>
                
                <div class="form-group">
                    <label for="craftsmanColor">Farve</label>
                    <input type="color" class="form-control" id="craftsmanColor" value="#2196F3">
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" id="cancelCraftsmanBtn">Annull√©r</button>
                    <button type="submit" class="btn btn-primary">Tilf√∏j</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Application State - Capellas All√© Project
        let appState = {
            project: {
                name: "Capellas All√© 38 Renovering",
                address: "Capellas All√© 38, 2770 Kastrup",
                customer: "Maria Josefina Herrera og Jose Eduardo Gran",
                startDate: "2025-09-08",
                totalValue: "99.100 DKK",
                phone: "+45 50 11 22 03"
            },
            craftsmen: [
                {id: "byggeleder", name: "Byggeleder", color: "#4A90E2", order: 0},
                {id: "toemrer", name: "T√∏mrer", color: "#8B4513", order: 1},
                {id: "elektriker", name: "Elektriker", color: "#FFD700", order: 2},
                {id: "vvs", name: "VVS-mont√∏r", color: "#32CD32", order: 3}
            ],
            tasks: [
                {id: "task1", title: "Nedrivning af v√¶gge", description: "30 m¬≤ v√¶g nedrivning", craftsman: "toemrer", startDay: 1, duration: 3, priority: "high", status: "planned", dependencies: [], isHalfDay: false},
                {id: "task2", title: "Isolering og gipsplader", description: "200 mm mineraluld og nye gipsplader", craftsman: "toemrer", startDay: 4, duration: 4, priority: "high", status: "planned", dependencies: ["task1"], isHalfDay: false},
                {id: "task3", title: "El-installation", description: "Alt el-arbejde til k√∏kken", craftsman: "elektriker", startDay: 6, duration: 3, priority: "high", status: "planned", dependencies: ["task1"], isHalfDay: false},
                {id: "task4", title: "VVS-installation", description: "Vand og afl√∏b til k√∏kken, ny radiator", craftsman: "vvs", startDay: 7, duration: 4, priority: "high", status: "planned", dependencies: ["task1"], isHalfDay: false},
                {id: "task5", title: "Spartling og slibning", description: "Komplet spartling af inderv√¶gge", craftsman: "toemrer", startDay: 8, duration: 2, priority: "medium", status: "planned", dependencies: ["task2"], isHalfDay: true},
                {id: "task6", title: "Maling", description: "Akrylmaling p√• alle v√¶gge", craftsman: "toemrer", startDay: 11, duration: 3, priority: "medium", status: "planned", dependencies: ["task3", "task4", "task5"], isHalfDay: false},
                {id: "task7", title: "K√∏kkeninstallation", description: "Levering og installation af k√∏kken", craftsman: "toemrer", startDay: 14, duration: 2, priority: "high", status: "planned", dependencies: ["task6"], isHalfDay: false},
                {id: "task8", title: "Projektoverv√•gning", description: "Daglig koordination og kvalitetskontrol", craftsman: "byggeleder", startDay: 1, duration: 15, priority: "medium", status: "planned", dependencies: [], isHalfDay: false}
            ],
            weeks: 3
        };
        
        let history = [];
        let historyIndex = -1;
        let currentEditingTask = null;
        let draggedElement = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                saveState();
                renderAll();
                setupEventListeners();
                showToast('Switzea Projektplanl√¶gning indl√¶st - alle h√•ndv√¶rkere i dedikeret kolonne!');
            }, 500);
        });
        
        function saveState() {
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            history.push(JSON.stringify(appState));
            historyIndex++;
            if (history.length > 50) {
                history.shift();
                historyIndex--;
            }
            updateUndoRedoButtons();
        }
        
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                appState = JSON.parse(history[historyIndex]);
                renderAll();
                updateUndoRedoButtons();
                showToast('Handling fortrudt');
            }
        }
        
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                appState = JSON.parse(history[historyIndex]);
                renderAll();
                updateUndoRedoButtons();
                showToast('Handling gendannet');
            }
        }
        
        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = historyIndex <= 0;
            document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
        }
        
        function renderAll() {
            renderCraftsmen();
            renderTimeline();
            updateWeekDisplay();
        }
        
        function renderCraftsmen() {
            const list = document.getElementById('craftsmanList');
            list.innerHTML = '';
            
            const sortedCraftsmen = [...appState.craftsmen].sort((a, b) => a.order - b.order);
            
            sortedCraftsmen.forEach(craftsman => {
                const li = document.createElement('li');
                li.className = 'craftsman-item';
                li.style.borderLeftColor = craftsman.color;
                li.draggable = true;
                li.dataset.id = craftsman.id;
                
                li.innerHTML = `
                    <span>${craftsman.name}</span>
                    <button class="delete-craftsman" onclick="deleteCraftsman('${craftsman.id}')">√ó</button>
                `;
                
                li.addEventListener('dragstart', (e) => {
                    draggedElement = li;
                    li.classList.add('dragging');
                });
                
                li.addEventListener('dragend', () => {
                    li.classList.remove('dragging');
                    draggedElement = null;
                });
                
                li.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                li.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== li) {
                        reorderCraftsmen(draggedElement.dataset.id, li.dataset.id);
                    }
                });
                
                list.appendChild(li);
            });
        }
        
        function renderTimeline() {
            const grid = document.getElementById('timelineGrid');
            grid.innerHTML = '';
            
            const totalDays = appState.weeks * 5;
            const sortedCraftsmen = [...appState.craftsmen].sort((a, b) => a.order - b.order);
            
            // Create header
            const header = document.createElement('div');
            header.className = 'grid-header';
            
            const craftsmanHeader = document.createElement('div');
            craftsmanHeader.className = 'header-craftsman';
            craftsmanHeader.textContent = 'H√•ndv√¶rkere';
            header.appendChild(craftsmanHeader);
            
            const daysHeader = document.createElement('div');
            daysHeader.className = 'header-days';
            
            for (let week = 1; week <= appState.weeks; week++) {
                const days = ['Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag'];
                days.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.innerHTML = `<div><strong>Uge ${week}</strong></div><div>${day}</div>`;
                    daysHeader.appendChild(dayHeader);
                });
            }
            
            header.appendChild(daysHeader);
            grid.appendChild(header);
            
            const body = document.createElement('div');
            body.className = 'grid-body';
            
            sortedCraftsmen.forEach((craftsman) => {
                const row = document.createElement('div');
                row.className = 'grid-row';
                row.dataset.craftsman = craftsman.id;
                
                const nameCell = document.createElement('div');
                nameCell.className = 'row-craftsman';
                nameCell.style.borderLeftColor = craftsman.color;
                nameCell.textContent = craftsman.name;
                row.appendChild(nameCell);
                
                const daysContainer = document.createElement('div');
                daysContainer.className = 'row-days';
                
                for (let day = 1; day <= totalDays; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.dataset.day = day;
                    cell.dataset.craftsman = craftsman.id;
                    
                    cell.addEventListener('click', () => {
                        createTask(craftsman.id, day);
                    });
                    
                    cell.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        if (draggedElement && draggedElement.classList.contains('task')) {
                            cell.classList.add('drop-zone');
                        }
                    });
                    
                    cell.addEventListener('dragleave', () => {
                        cell.classList.remove('drop-zone');
                    });
                    
                    cell.addEventListener('drop', (e) => {
                        e.preventDefault();
                        cell.classList.remove('drop-zone');
                        
                        if (draggedElement && draggedElement.classList.contains('task')) {
                            const taskId = draggedElement.dataset.taskId;
                            const newDay = parseInt(cell.dataset.day);
                            const newCraftsman = cell.dataset.craftsman;
                            
                            if (newDay <= totalDays) {
                                moveTask(taskId, newCraftsman, newDay);
                            }
                        }
                    });
                    
                    daysContainer.appendChild(cell);
                }
                
                row.appendChild(daysContainer);
                body.appendChild(row);
            });
            
            grid.appendChild(body);
            
            setTimeout(() => renderTasks(), 100);
        }
        
        function renderTasks() {
            document.querySelectorAll('.task').forEach(task => task.remove());
            
            const totalDays = appState.weeks * 5;
            
            appState.tasks.forEach(task => {
                if (task.startDay > totalDays || task.startDay + task.duration - 1 > totalDays) {
                    return;
                }
                
                const craftsmanRow = document.querySelector(`[data-craftsman="${task.craftsman}"]`);
                if (!craftsmanRow) return;
                
                const startCell = craftsmanRow.querySelector(`[data-day="${task.startDay}"]`);
                if (!startCell) return;
                
                const taskElement = document.createElement('div');
                taskElement.className = `task ${task.priority} ${task.status}`;
                if (task.isHalfDay) {
                    taskElement.classList.add('half-day');
                }
                
                taskElement.dataset.taskId = task.id;
                taskElement.draggable = true;
                
                const cellWidth = startCell.offsetWidth || 100;
                const width = task.duration * cellWidth - 4;
                taskElement.style.width = `${width}px`;
                taskElement.style.left = '2px';
                
                taskElement.innerHTML = `
                    <div class="task-title">${task.title}</div>
                    <div class="task-controls">
                        <button class="task-btn" onclick="editTask('${task.id}')">‚úèÔ∏è</button>
                        <button class="task-btn" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
                    </div>
                `;
                
                taskElement.addEventListener('dragstart', (e) => {
                    draggedElement = taskElement;
                    taskElement.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                taskElement.addEventListener('dragend', () => {
                    taskElement.classList.remove('dragging');
                    draggedElement = null;
                });
                
                taskElement.addEventListener('dblclick', () => {
                    editTask(task.id);
                });
                
                startCell.appendChild(taskElement);
            });
        }
        
        function createTask(craftsman, startDay) {
            currentEditingTask = null;
            document.getElementById('modalTitle').textContent = 'Ny opgave';
            document.getElementById('deleteTaskBtn').style.display = 'none';
            
            document.getElementById('taskForm').reset();
            document.getElementById('taskCraftsman').value = craftsman;
            
            populateCraftsmanDropdown();
            document.getElementById('taskModal').classList.add('show');
        }
        
        function editTask(taskId) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            currentEditingTask = task;
            document.getElementById('modalTitle').textContent = 'Redig√©r opgave';
            document.getElementById('deleteTaskBtn').style.display = 'inline-block';
            
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskDuration').value = task.duration;
            document.getElementById('taskHalfDay').checked = task.isHalfDay;
            
            populateCraftsmanDropdown();
            document.getElementById('taskCraftsman').value = task.craftsman;
            
            document.getElementById('taskModal').classList.add('show');
        }
        
        function populateCraftsmanDropdown() {
            const select = document.getElementById('taskCraftsman');
            select.innerHTML = '';
            appState.craftsmen.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                select.appendChild(option);
            });
        }
        
        function saveTask() {
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                craftsman: document.getElementById('taskCraftsman').value,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                duration: parseFloat(document.getElementById('taskDuration').value),
                isHalfDay: document.getElementById('taskHalfDay').checked
            };
            
            if (currentEditingTask) {
                Object.assign(currentEditingTask, taskData);
            } else {
                const newTask = {
                    id: 'task_' + Date.now(),
                    startDay: 1,
                    dependencies: [],
                    ...taskData
                };
                appState.tasks.push(newTask);
            }
            
            saveState();
            renderAll();
            closeModal('taskModal');
            showToast('Opgave gemt');
        }
        
        function deleteTask(taskId) {
            if (confirm('Er du sikker p√• at du vil slette denne opgave?')) {
                appState.tasks = appState.tasks.filter(t => t.id !== taskId);
                saveState();
                renderAll();
                closeModal('taskModal');
                showToast('Opgave slettet');
            }
        }
        
        function moveTask(taskId, newCraftsman, newStartDay) {
            const task = appState.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const totalDays = appState.weeks * 5;
            if (newStartDay + task.duration - 1 > totalDays) {
                showToast('Opgaven passer ikke inden for det valgte antal uger', 'error');
                return;
            }
            
            task.craftsman = newCraftsman;
            task.startDay = newStartDay;
            
            saveState();
            renderTasks();
            showToast('Opgave flyttet');
        }
        
        function addCraftsman(name, color) {
            const id = 'craftsman_' + Date.now();
            const newCraftsman = {
                id: id,
                name: name,
                color: color,
                order: appState.craftsmen.length
            };
            
            appState.craftsmen.push(newCraftsman);
            saveState();
            renderAll();
            showToast('H√•ndv√¶rker tilf√∏jet');
        }
        
        function deleteCraftsman(craftsmanId) {
            if (confirm('Er du sikker p√• at du vil slette denne h√•ndv√¶rker? Alle tilh√∏rende opgaver vil ogs√• blive slettet.')) {
                appState.craftsmen = appState.craftsmen.filter(c => c.id !== craftsmanId);
                appState.tasks = appState.tasks.filter(t => t.craftsman !== craftsmanId);
                
                appState.craftsmen.forEach((c, index) => {
                    c.order = index;
                });
                
                saveState();
                renderAll();
                showToast('H√•ndv√¶rker slettet');
            }
        }
        
        function reorderCraftsmen(draggedId, targetId) {
            const draggedIndex = appState.craftsmen.findIndex(c => c.id === draggedId);
            const targetIndex = appState.craftsmen.findIndex(c => c.id === targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            const [draggedCraftsman] = appState.craftsmen.splice(draggedIndex, 1);
            appState.craftsmen.splice(targetIndex, 0, draggedCraftsman);
            
            appState.craftsmen.forEach((c, index) => {
                c.order = index;
            });
            
            saveState();
            renderAll();
            showToast('H√•ndv√¶rker-r√¶kkef√∏lge opdateret');
        }
        
        function addWeek() {
            appState.weeks++;
            saveState();
            renderAll();
            showToast('Uge tilf√∏jet');
        }
        
        function removeWeek() {
            if (appState.weeks > 1) {
                appState.weeks--;
                const newTotalDays = appState.weeks * 5;
                
                appState.tasks = appState.tasks.filter(task => {
                    return task.startDay <= newTotalDays && (task.startDay + task.duration - 1) <= newTotalDays;
                });
                
                saveState();
                renderAll();
                showToast('Uge fjernet');
            }
        }
        
        function updateWeekDisplay() {
            document.getElementById('weekDisplay').textContent = `${appState.weeks} uger`;
        }
        
        function saveProject() {
            try {
                localStorage.setItem('switzeaProject', JSON.stringify(appState));
                showToast('Projekt gemt');
            } catch (error) {
                showToast('Fejl ved gem: ' + error.message, 'error');
            }
        }
        
        function loadProject() {
            try {
                const saved = localStorage.getItem('switzeaProject');
                if (saved) {
                    appState = JSON.parse(saved);
                    saveState();
                    renderAll();
                    showToast('Projekt indl√¶st');
                } else {
                    showToast('Ingen gemt projekt fundet', 'warning');
                }
            } catch (error) {
                showToast('Fejl ved indl√¶sning: ' + error.message, 'error');
            }
        }
        
        function exportToPDF() {
            const printWindow = window.open('', '_blank');
            const content = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${appState.project.name} - Projektplan</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.5; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2196F3; padding-bottom: 20px; }
                        .logo { font-size: 2em; font-weight: bold; color: #2196F3; margin-bottom: 10px; }
                        .project-info { margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 5px solid #2196F3; }
                        .timeline { margin-top: 25px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background: linear-gradient(145deg, #f8f9fa, #e9ecef); font-weight: bold; color: #495057; }
                        .task-high { background-color: #ffebee; border-left: 4px solid #f44336; }
                        .task-medium { background-color: #fff3e0; border-left: 4px solid #ff9800; }
                        .task-low { background-color: #e8f5e8; border-left: 4px solid #4caf50; }
                        .completed { background-color: #e8f5e8; }
                        .in-progress { background-color: #e3f2fd; }
                        .footer { margin-top: 30px; font-size: 0.9em; color: #666; border-top: 1px solid #ddd; padding-top: 15px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">SWITZEA ApS</div>
                        <h2>Projektplan & Tidsplan</h2>
                    </div>
                    <div class="project-info">
                        <h3>${appState.project.name}</h3>
                        <p><strong>üìç Adresse:</strong> ${appState.project.address}</p>
                        <p><strong>üë• Kunde:</strong> ${appState.project.customer}</p>
                        <p><strong>üí∞ Projektv√¶rdi:</strong> ${appState.project.totalValue}</p>
                        <p><strong>üìÖ Startdato:</strong> ${appState.project.startDate}</p>
                        <p><strong>‚è±Ô∏è Projektperiode:</strong> ${appState.weeks} uger (${appState.weeks * 5} arbejdsdage)</p>
                    </div>
                    <div class="timeline">
                        <h3>üìã Detaljeret Opgaveoversigt</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 30%">Opgave & Beskrivelse</th>
                                    <th style="width: 15%">H√•ndv√¶rker</th>
                                    <th style="width: 10%">Startdag</th>
                                    <th style="width: 15%">Varighed</th>
                                    <th style="width: 10%">Prioritet</th>
                                    <th style="width: 20%">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appState.tasks.map(task => {
                                    const craftsman = appState.craftsmen.find(c => c.id === task.craftsman);
                                    const priorityText = task.priority === 'high' ? 'H√∏j ‚ö†Ô∏è' : task.priority === 'medium' ? 'Medium ‚ö°' : 'Lav ‚úÖ';
                                    const statusText = task.status === 'planned' ? 'Planlagt üìã' : task.status === 'in-progress' ? 'I gang üîÑ' : 'Udf√∏rt ‚úÖ';
                                    return `
                                        <tr class="task-${task.priority} ${task.status}">
                                            <td>
                                                <strong>${task.title}</strong>
                                                ${task.description ? `<br><small style="color: #666;">${task.description}</small>` : ''}
                                            </td>
                                            <td><strong>${craftsman ? craftsman.name : task.craftsman}</strong></td>
                                            <td>Dag ${task.startDay}</td>
                                            <td>${task.duration} dag${task.duration !== 1 ? 'e' : ''}${task.isHalfDay ? ' <em>(halv dag)</em>' : ''}</td>
                                            <td>${priorityText}</td>
                                            <td>${statusText}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="footer">
                        <p><strong>Genereret:</strong> ${new Date().toLocaleString('da-DK')} | <strong>SWITZEA ApS</strong> | Projektplanl√¶gning v2</p>
                        <p><em>Dette dokument er genereret automatisk fra Switzea's projektplanl√¶gningssystem</em></p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.print();
            
            showToast('üìÑ PDF kundevisning eksporteret!');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
        
        function setupEventListeners() {
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);
            document.getElementById('addWeekBtn').addEventListener('click', addWeek);
            document.getElementById('removeWeekBtn').addEventListener('click', removeWeek);
            document.getElementById('saveBtn').addEventListener('click', saveProject);
            document.getElementById('loadBtn').addEventListener('click', loadProject);
            document.getElementById('pdfBtn').addEventListener('click', exportToPDF);
            
            document.getElementById('addCraftsmanBtn').addEventListener('click', () => {
                document.getElementById('craftsmanForm').reset();
                document.getElementById('craftsmanModal').classList.add('show');
            });
            
            document.getElementById('taskForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveTask();
            });
            
            document.getElementById('craftsmanForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('craftsmanName').value;
                const color = document.getElementById('craftsmanColor').value;
                addCraftsman(name, color);
                closeModal('craftsmanModal');
            });
            
            document.getElementById('cancelBtn').addEventListener('click', () => closeModal('taskModal'));
            document.getElementById('cancelCraftsmanBtn').addEventListener('click', () => closeModal('craftsmanModal'));
            document.getElementById('deleteTaskBtn').addEventListener('click', () => {
                if (currentEditingTask) {
                    deleteTask(currentEditingTask.id);
                }
            });
            
            document.getElementById('customerViewBtn').addEventListener('click', () => {
                showToast('üì§ Eksporterer professionel kundevisning...');
                setTimeout(exportToPDF, 500);
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'z':
                            e.preventDefault();
                            if (e.shiftKey) redo();
                            else undo();
                            break;
                        case 'y':
                            e.preventDefault();
                            redo();
                            break;
                        case 's':
                            e.preventDefault();
                            saveProject();
                            break;
                    }
                }
                
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.show').forEach(modal => {
                        modal.classList.remove('show');
                    });
                }
            });
            
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('show');
                }
            });
        }
        
        window.editTask = editTask;
        window.deleteTask = deleteTask;
        window.deleteCraftsman = deleteCraftsman;
    </script>
</body>
</html>