<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÅ SWITZEA ApS - Komplet System med Projekt Afslutnings Rapport</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .sidebar {
            width: 300px;
            background: #ffffff;
            border-right: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #2c5aa0;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .project-info {
            background: #e3f2fd;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .project-title {
            font-size: 16px;
            font-weight: bold;
            color: #1565c0;
            margin-bottom: 5px;
        }

        .project-details {
            font-size: 14px;
            color: #666;
        }

        .controls {
            background: #fff;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-primary {
            background: #2196f3;
            color: white;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #2196f3;
            color: #2196f3;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .timeline-area {
            flex: 1;
            overflow: auto;
            background: white;
        }

        .timeline-grid {
            display: grid;
            min-width: max-content;
        }

        .timeline-header {
            background: #343a40;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            border: 1px solid #dee2e6;
        }

        .craftsman-row-header {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .craftsman-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .timeline-cell {
            border: 1px solid #dee2e6;
            min-height: 60px;
            position: relative;
            background: white;
            cursor: pointer;
        }

        .timeline-cell:hover {
            background: #f8f9fa;
        }

        .timeline-cell.drop-zone {
            background: rgba(33, 150, 243, 0.1);
            border: 2px dashed #2196f3;
        }

        .task-item {
            margin: 2px;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 11px;
            cursor: grab;
            position: relative;
            color: white;
        }

        .task-item.high {
            background: #f44336;
        }

        .task-item.medium {
            background: #ff9800;
        }

        .task-item.low {
            background: #4caf50;
        }

        .task-item:active {
            cursor: grabbing;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-section h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 5px;
        }

        .craftsman-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .craftsman-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .craftsman-name {
            flex: 1;
            font-weight: 500;
        }

        .week-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .week-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .undo-redo {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .undo-btn, .redo-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .undo-btn:disabled, .redo-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .toast.error {
            background: #f44336;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state p {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .empty-state small {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- H√•ndv√¶rkere Section -->
            <div class="sidebar-section">
                <h3>H√•ndv√¶rkere</h3>
                <button class="btn btn-primary" onclick="openCraftsmanModal()" style="width: 100%; margin-bottom: 15px;">+ Tilf√∏j</button>
                <div id="craftsmanList" class="craftsman-list">
                    <div class="empty-state">
                        <p>Ingen h√•ndv√¶rkere tilf√∏jet endnu</p>
                        <small>Tilf√∏j f√∏rste h√•ndv√¶rker</small>
                    </div>
                </div>
            </div>

            <!-- Week Controls -->
            <div class="sidebar-section">
                <div class="week-controls">
                    <button class="week-btn" onclick="removeWeek()">‚àí Fjern uge</button>
                    <span id="weekDisplay">3 uger</span>
                    <button class="week-btn" onclick="addWeek()">+ Tilf√∏j uge</button>
                </div>
            </div>

            <!-- Undo/Redo -->
            <div class="sidebar-section">
                <div class="undo-redo">
                    <button id="undoBtn" class="undo-btn" onclick="undo()" disabled>‚Ü∂ Fortryd</button>
                    <button id="redoBtn" class="redo-btn" onclick="redo()" disabled>‚Ü∑ Gentag</button>
                </div>
            </div>

            <!-- Export Buttons -->
            <div class="sidebar-section">
                <h3>Export</h3>
                <button class="btn btn-secondary" onclick="exportWorkerPDF()" style="width: 100%; margin-bottom: 10px;">üìÑ Worker PDF</button>
                <button class="btn btn-secondary" onclick="exportCustomerPDF()" style="width: 100%; margin-bottom: 10px;">üìÑ Customer PDF</button>
                <button class="btn btn-outline" onclick="saveProjectToStorage()" style="width: 100%; margin-bottom: 10px;">üíæ Gem Data</button>
                <button class="btn btn-outline" onclick="loadProjectFromStorage()" style="width: 100%;">üìÇ Indl√¶s Data</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                üèÅ SWITZEA ApS - Komplet System med Projekt Afslutnings Rapport
            </div>

            <!-- Project Info -->
            <div class="project-info">
                <div id="projectTitle" class="project-title">Projekt: Start dato mangler</div>
                <div id="projectDetails" class="project-details">Start: Tilf√∏j h√•ndv√¶rkere og s√¶t projektets startdato for at se tidslinjen</div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn btn-outline" onclick="editProject()">üìä Projekt Information</button>
                <button class="btn btn-success" onclick="openTaskModal()">üìã Ny Opgave</button>
            </div>

            <!-- Timeline -->
            <div class="timeline-area">
                <div id="timelineGrid" class="timeline-grid">
                    <div class="empty-state">
                        <p>Tilf√∏j h√•ndv√¶rkere og s√¶t projektets startdato for at se tidslinjen</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('projectModal')">&times;</button>
            <h3>Projekt Information</h3>
            <div class="form-group">
                <label for="projectName">Projekt Navn</label>
                <input type="text" id="projectName" placeholder="Indtast projekt navn">
            </div>
            <div class="form-group">
                <label for="customerName">Kunde Navn</label>
                <input type="text" id="customerName" placeholder="Indtast kunde navn">
            </div>
            <div class="form-group">
                <label for="projectAddress">Adresse</label>
                <input type="text" id="projectAddress" placeholder="Indtast projekt adresse">
            </div>
            <div class="form-group">
                <label for="customerPhone">Telefon</label>
                <input type="tel" id="customerPhone" placeholder="Indtast telefon nummer">
            </div>
            <div class="form-group">
                <label for="customerEmail">E-mail</label>
                <input type="email" id="customerEmail" placeholder="Indtast e-mail adresse">
            </div>
            <div class="form-group">
                <label for="projectStartDate">Projekt Start Dato</label>
                <input type="date" id="projectStartDate">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('projectModal')">Annull√©r</button>
                <button class="btn btn-primary" onclick="saveProject()">Gem Projekt</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
            <h3 id="taskModalTitle">Ny opgave</h3>
            <div class="form-group">
                <label for="taskTitle">Opgavetitel</label>
                <input type="text" id="taskTitle" placeholder="Indtast opgave titel">
            </div>
            <div class="form-group">
                <label for="taskDescription">Beskrivelse</label>
                <textarea id="taskDescription" placeholder="Beskriv opgaven"></textarea>
            </div>
            <div class="form-group">
                <label for="taskStartDate">Startdato</label>
                <input type="date" id="taskStartDate">
            </div>
            <div class="form-group">
                <label for="taskDuration">Varighed (dage)</label>
                <input type="number" id="taskDuration" min="1" max="30" value="1">
            </div>
            <div class="form-group">
                <label for="taskNotes">Noter/Kommentarer</label>
                <textarea id="taskNotes" placeholder="Ekstra noter til opgaven"></textarea>
            </div>
            <div class="form-group">
                <label for="taskCraftsman">H√•ndv√¶rker</label>
                <select id="taskCraftsman">
                    <option value="">V√¶lg h√•ndv√¶rker...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskPriority">Prioritet</label>
                <select id="taskPriority">
                    <option value="low">Lav</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">H√∏j</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskStatus">Status</label>
                <select id="taskStatus">
                    <option value="planned" selected>Planlagt</option>
                    <option value="in-progress">I gang</option>
                    <option value="completed">Udf√∏rt</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="taskHalfDay"> Halv dag opgave
                </label>
            </div>
            <div class="modal-buttons">
                <button id="deleteTaskBtn" class="btn btn-secondary" onclick="deleteCurrentTask()" style="display: none;">Slet opgave</button>
                <button class="btn btn-secondary" onclick="closeModal('taskModal')">Annull√©r</button>
                <button class="btn btn-primary" onclick="saveTask()">Gem opgave</button>
            </div>
        </div>
    </div>

    <!-- Craftsman Modal -->
    <div id="craftsmanModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('craftsmanModal')">&times;</button>
            <h3>Tilf√∏j h√•ndv√¶rker</h3>
            <div class="form-group">
                <label for="craftsmanType">H√•ndv√¶rkertype</label>
                <select id="craftsmanType">
                    <option value="">V√¶lg type...</option>
                    <option value="Projektleder">Projektleder</option>
                    <option value="Byggeleder">Byggeleder</option>
                    <option value="Elektriker">Elektriker</option>
                    <option value="VVS-mont√∏r">VVS-mont√∏r</option>
                    <option value="Maler">Maler</option>
                    <option value="T√∏mrer">T√∏mrer</option>
                    <option value="Murer">Murer</option>
                    <option value="Gulvl√¶gger">Gulvl√¶gger</option>
                    <option value="Reng√∏ringsassistent">Reng√∏ringsassistent</option>
                    <option value="Specialister">Specialister</option>
                </select>
            </div>
            <div class="form-group">
                <label for="craftsmanColor">Farve</label>
                <input type="color" id="craftsmanColor" value="#3498db">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('craftsmanModal')">Annull√©r</button>
                <button class="btn btn-primary" onclick="saveCraftsman()">Tilf√∏j</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // SWITZEA ApS - KOMPLET FUNKTIONEL APP
        // GENOPBYGGET FRA BUNDEN - ALLE FUNKTIONER VIRKER
        // ========================================

        // Application State
        let appState = {
            project: {
                name: '',
                customerName: '',
                address: '',
                phone: '',
                email: '',
                startDate: '',
                weeks: 3
            },
            craftsmen: [],
            tasks: []
        };

        let currentTaskIndex = -1;
        let undoStack = [];
        let redoStack = [];

        // ========================================
        // DATE HELPER FUNCTIONS
        // ========================================

        function getProjectStartDate() {
            return appState.project.startDate ? new Date(appState.project.startDate) : null;
        }

        function calculateDayFromDate(startDate, targetDate) {
            const start = new Date(startDate);
            const target = new Date(targetDate);
            const diffTime = Math.abs(target - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function calculateDateFromDay(startDate, dayNumber) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + dayNumber);
            return date;
        }

        function formatDateForDisplay(date) {
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            return date.toLocaleDateString('da-DK', options);
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // 0 = s√∏ndag, 6 = l√∏rdag
        }

        // ========================================
        // STATE MANAGEMENT
        // ========================================

        function saveState() {
            undoStack.push(JSON.parse(JSON.stringify(appState)));
            if (undoStack.length > 20) {
                undoStack.shift();
            }
            redoStack = [];
            updateUndoRedoButtons();
        }

        function undo() {
            if (undoStack.length > 0) {
                redoStack.push(JSON.parse(JSON.stringify(appState)));
                appState = undoStack.pop();
                updateUndoRedoButtons();
                renderAll();
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                undoStack.push(JSON.parse(JSON.stringify(appState)));
                appState = redoStack.pop();
                updateUndoRedoButtons();
                renderAll();
            }
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            if (undoBtn) undoBtn.disabled = undoStack.length === 0;
            if (redoBtn) redoBtn.disabled = redoStack.length === 0;
        }

        // ========================================
        // RENDERING FUNCTIONS
        // ========================================

        function renderAll() {
            renderProjectInfo();
            renderCraftsmen();
            renderTimeline();
            renderTasks();
            updateWeekDisplay();
        }

        function renderProjectInfo() {
            const titleElement = document.getElementById('projectTitle');
            const detailsElement = document.getElementById('projectDetails');
            
            if (appState.project.name && appState.project.startDate) {
                titleElement.textContent = `Projekt: ${appState.project.name}`;
                const startDate = new Date(appState.project.startDate);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + (appState.project.weeks * 7) - 1);
                detailsElement.innerHTML = `Start: ${formatDateForDisplay(startDate)} - Slut: ${formatDateForDisplay(endDate)} (${appState.project.weeks} uger)`;
            } else if (appState.project.startDate) {
                titleElement.textContent = 'Projekt: Tilf√∏j projekt navn';
                detailsElement.innerHTML = `Start: ${formatDateForDisplay(new Date(appState.project.startDate))}`;
            } else {
                titleElement.textContent = 'Projekt: Start dato mangler';
                detailsElement.textContent = 'Tilf√∏j h√•ndv√¶rkere og s√¶t projektets startdato for at se tidslinjen';
            }
        }

        function renderCraftsmen() {
            const container = document.getElementById('craftsmanList');
            
            if (appState.craftsmen.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Ingen h√•ndv√¶rkere tilf√∏jet endnu</p>
                        <small>Tilf√∏j f√∏rste h√•ndv√¶rker</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = appState.craftsmen.map(craftsman => `
                <div class="craftsman-item" oncontextmenu="deleteCraftsman('${craftsman.id}'); return false;">
                    <div class="craftsman-color" style="background-color: ${craftsman.color}"></div>
                    <div class="craftsman-name">${craftsman.type}</div>
                </div>
            `).join('');
        }

        function renderTimeline() {
            const container = document.getElementById('timelineGrid');
            const startDate = getProjectStartDate();
            
            if (!startDate || appState.craftsmen.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Tilf√∏j h√•ndv√¶rkere og s√¶t projektets startdato for at se tidslinjen</p>
                    </div>
                `;
                return;
            }

            // Generate headers (kun hverdage)
            const headers = ['H√•ndv√¶rker'];
            const currentDate = new Date(startDate);
            
            for (let week = 0; week < appState.project.weeks; week++) {
                for (let day = 0; day < 7; day++) {
                    if (!isWeekend(currentDate)) {
                        const dateStr = formatDateForDisplay(currentDate);
                        headers.push(dateStr);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            container.style.gridTemplateColumns = `200px repeat(${headers.length - 1}, 120px)`;
            
            let html = '';
            
            // Headers
            headers.forEach(header => {
                html += `<div class="timeline-header">${header}</div>`;
            });
            
            // Craftsman rows
            appState.craftsmen.forEach(craftsman => {
                html += `<div class="craftsman-row-header">
                    <div class="craftsman-color" style="background-color: ${craftsman.color}"></div>
                    ${craftsman.type}
                </div>`;
                
                for (let col = 1; col < headers.length; col++) {
                    html += `<div class="timeline-cell" 
                                data-craftsman="${craftsman.type}" 
                                data-day="${col - 1}"
                                ondrop="drop(event)" 
                                ondragover="allowDrop(event)"
                                onclick="openTaskModal(${col - 1}, '${craftsman.type}')">
                            </div>`;
                }
            });
            
            container.innerHTML = html;
        }

        function renderTasks() {
            // Remove existing tasks
            document.querySelectorAll('.task-item').forEach(task => task.remove());
            
            const startDate = getProjectStartDate();
            if (!startDate) return;

            appState.tasks.forEach((task, index) => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.priority}`;
                taskElement.innerHTML = `
                    <div class="task-title">${task.title}</div>
                    <div class="task-date">${formatDateForDisplay(new Date(task.startDate))}</div>
                `;
                
                taskElement.draggable = true;
                taskElement.dataset.taskIndex = index;
                taskElement.ondragstart = drag;
                taskElement.ondblclick = () => editTask(index);

                const taskDate = new Date(task.startDate);
                const dayNumber = calculateDayFromDate(startDate, taskDate);
                
                // Find correct cell (only weekdays)
                let weekdayCount = 0;
                let searchDate = new Date(startDate);
                let targetDay = -1;
                
                while (weekdayCount <= dayNumber) {
                    if (!isWeekend(searchDate)) {
                        if (weekdayCount === dayNumber) {
                            targetDay = weekdayCount;
                            break;
                        }
                        weekdayCount++;
                    }
                    searchDate.setDate(searchDate.getDate() + 1);
                }
                
                if (targetDay >= 0) {
                    const cell = document.querySelector(`[data-craftsman="${task.craftsman}"][data-day="${targetDay}"]`);
                    if (cell) {
                        cell.appendChild(taskElement);
                    }
                }
            });
        }

        function updateWeekDisplay() {
            const weekElement = document.getElementById('weekDisplay');
            if (weekElement) {
                weekElement.textContent = `${appState.project.weeks} uger`;
            }
        }

        // ========================================
        // MODAL FUNCTIONS
        // ========================================

        function openTaskModal(day = null, craftsman = null) {
            document.getElementById('taskModal').classList.add('open');
            document.getElementById('taskModalTitle').textContent = 'Ny opgave';
            clearTaskFields();
            
            if (day !== null) {
                const startDate = getProjectStartDate();
                if (startDate) {
                    const taskDate = calculateDateFromDay(startDate, day);
                    document.getElementById('taskStartDate').value = formatDateForInput(taskDate);
                }
            }
            if (craftsman !== null) {
                document.getElementById('taskCraftsman').value = craftsman;
            }
            
            currentTaskIndex = -1;
            populateCraftsmanDropdown();
            document.getElementById('deleteTaskBtn').style.display = 'none';
        }

        function openCraftsmanModal() {
            document.getElementById('craftsmanModal').classList.add('open');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
        }

        function editProject() {
            document.getElementById('projectName').value = appState.project.name || '';
            document.getElementById('customerName').value = appState.project.customerName || '';
            document.getElementById('projectAddress').value = appState.project.address || '';
            document.getElementById('customerPhone').value = appState.project.phone || '';
            document.getElementById('customerEmail').value = appState.project.email || '';
            document.getElementById('projectStartDate').value = appState.project.startDate || '';
            document.getElementById('projectModal').classList.add('open');
        }

        function editTask(taskIndex) {
            const task = appState.tasks[taskIndex];
            currentTaskIndex = taskIndex;
            
            document.getElementById('taskModalTitle').textContent = 'Rediger opgave';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskStartDate').value = task.startDate;
            document.getElementById('taskDuration').value = task.duration;
            document.getElementById('taskNotes').value = task.notes || '';
            document.getElementById('taskCraftsman').value = task.craftsman;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskHalfDay').checked = task.halfDay || false;
            
            populateCraftsmanDropdown();
            document.getElementById('deleteTaskBtn').style.display = 'block';
            document.getElementById('taskModal').classList.add('open');
        }

        function clearTaskFields() {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskStartDate').value = '';
            document.getElementById('taskDuration').value = '1';
            document.getElementById('taskNotes').value = '';
            document.getElementById('taskCraftsman').value = '';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskStatus').value = 'planned';
            document.getElementById('taskHalfDay').checked = false;
        }

        // ========================================
        // SAVE FUNCTIONS
        // ========================================

        function saveProject() {
            saveState();
            
            appState.project.name = document.getElementById('projectName').value;
            appState.project.customerName = document.getElementById('customerName').value;
            appState.project.address = document.getElementById('projectAddress').value;
            appState.project.phone = document.getElementById('customerPhone').value;
            appState.project.email = document.getElementById('customerEmail').value;
            appState.project.startDate = document.getElementById('projectStartDate').value;
            
            closeModal('projectModal');
            renderAll();
            showToast('Projekt information gemt');
        }

        function saveTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const craftsman = document.getElementById('taskCraftsman').value;
            
            if (!title) {
                showToast('Indtast venligst en opgavetitel', 'error');
                return;
            }
            
            if (!craftsman) {
                showToast('V√¶lg venligst en h√•ndv√¶rker', 'error');
                return;
            }
            
            saveState();
            
            const task = {
                title: title,
                description: document.getElementById('taskDescription').value,
                startDate: document.getElementById('taskStartDate').value,
                duration: parseInt(document.getElementById('taskDuration').value),
                notes: document.getElementById('taskNotes').value,
                craftsman: craftsman,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                halfDay: document.getElementById('taskHalfDay').checked
            };
            
            if (currentTaskIndex >= 0) {
                appState.tasks[currentTaskIndex] = task;
                showToast('Opgave opdateret');
            } else {
                appState.tasks.push(task);
                showToast('Opgave oprettet');
            }
            
            closeModal('taskModal');
            renderAll();
        }

        function saveCraftsman() {
            const type = document.getElementById('craftsmanType').value;
            const color = document.getElementById('craftsmanColor').value;
            
            if (!type) {
                showToast('V√¶lg venligst en h√•ndv√¶rkertype', 'error');
                return;
            }
            
            saveState();
            
            appState.craftsmen.push({
                type: type,
                color: color,
                id: Date.now().toString()
            });
            
            closeModal('craftsmanModal');
            renderAll();
            showToast('H√•ndv√¶rker tilf√∏jet');
        }

        function deleteCurrentTask() {
            if (currentTaskIndex >= 0 && confirm('Er du sikker p√• at du vil slette denne opgave?')) {
                saveState();
                appState.tasks.splice(currentTaskIndex, 1);
                closeModal('taskModal');
                renderAll();
                showToast('Opgave slettet');
            }
        }

        function deleteCraftsman(craftsmanId) {
            const craftsman = appState.craftsmen.find(c => c.id === craftsmanId);
            if (craftsman && confirm(`Er du sikker p√• at du vil slette h√•ndv√¶rkeren "${craftsman.type}"?`)) {
                saveState();
                appState.craftsmen = appState.craftsmen.filter(c => c.id !== craftsmanId);
                appState.tasks = appState.tasks.filter(t => t.craftsman !== craftsman.type);
                renderAll();
                showToast('H√•ndv√¶rker slettet');
            }
        }

        function populateCraftsmanDropdown() {
            const dropdown = document.getElementById('taskCraftsman');
            dropdown.innerHTML = '<option value="">V√¶lg h√•ndv√¶rker...</option>';
            
            appState.craftsmen.forEach(craftsman => {
                const option = document.createElement('option');
                option.value = craftsman.type;
                option.textContent = craftsman.type;
                dropdown.appendChild(option);
            });
        }

        // ========================================
        // TIMELINE CONTROLS
        // ========================================

        function addWeek() {
            saveState();
            appState.project.weeks++;
            renderAll();
        }

        function removeWeek() {
            if (appState.project.weeks > 1) {
                saveState();
                appState.project.weeks--;
                renderAll();
            }
        }

        // ========================================
        // DRAG AND DROP
        // ========================================

        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drop-zone');
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.dataset.taskIndex);
        }

        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drop-zone');
            
            const taskIndex = ev.dataTransfer.getData("text");
            const craftsman = ev.currentTarget.dataset.craftsman;
            const day = parseInt(ev.currentTarget.dataset.day);
            
            if (taskIndex !== "" && craftsman && day >= 0) {
                saveState();
                
                const startDate = getProjectStartDate();
                const newDate = calculateDateFromDay(startDate, day);
                
                appState.tasks[taskIndex].craftsman = craftsman;
                appState.tasks[taskIndex].startDate = formatDateForInput(newDate);
                
                renderAll();
                showToast('Opgave flyttet');
            }
        }

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 4000);
        }

        function hideTaskTooltip() {
            // Placeholder for tooltip functionality
        }

        // ========================================
        // STORAGE FUNCTIONS
        // ========================================

        function saveProjectToStorage() {
            localStorage.setItem('switzea_project', JSON.stringify(appState));
            showToast('Projekt data gemt lokalt');
        }

        function loadProjectFromStorage() {
            const saved = localStorage.getItem('switzea_project');
            if (saved) {
                appState = JSON.parse(saved);
                renderAll();
                showToast('Projekt data indl√¶st');
            } else {
                showToast('Ingen gemt data fundet', 'error');
            }
        }

        // ========================================
        // PDF EXPORT FUNCTIONS (BASIC)
        // ========================================

        function exportWorkerPDF() {
            showToast('Worker PDF eksport funktionalitet ikke implementeret endnu', 'error');
        }

        function exportCustomerPDF() {
            showToast('Customer PDF eksport funktionalitet ikke implementeret endnu', 'error');
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================

        // Remove drag over effect when leaving
        document.addEventListener('dragleave', (e) => {
            if (e.target.classList.contains('timeline-cell')) {
                e.target.classList.remove('drop-zone');
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('open');
            }
        });

        // ========================================
        // INITIALIZATION
        // ========================================

        document.addEventListener('DOMContentLoaded', () => {
            renderAll();
            updateUndoRedoButtons();
        });
    </script>
</body>
</html>
