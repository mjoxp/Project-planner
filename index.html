<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWITZEA ApS - ENHANCED H√ÖNDV√ÜRKER PDF | Timeline + Dag-for-dag + H√•ndv√¶rker sektioner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3d72 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding: 20px;
        }

        .content-area {
            flex: 1;
            padding: 20px;
        }

        .project-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .project-info h3 {
            color: #1565c0;
            margin-bottom: 10px;
        }

        /* RETTET: Ny Opgave knap tilf√∏jet */
        .action-buttons {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .new-task-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .new-task-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .primary-btn {
            background: #2196f3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .primary-btn:hover {
            background: #1976d2;
        }

        .secondary-btn {
            background: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .craftsman-list {
            margin-bottom: 20px;
        }

        .craftsman-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: move;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .craftsman-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .craftsman-name {
            flex: 1;
            font-weight: 500;
        }

        .timeline-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .timeline-controls {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .week-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .timeline-grid {
            display: grid;
            border: 1px solid #dee2e6;
        }

        .timeline-header {
            background: #343a40;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
        }

        .timeline-row {
            display: contents;
        }

        .craftsman-row-header {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timeline-cell {
            border: 1px solid #dee2e6;
            min-height: 60px;
            position: relative;
            background: white;
        }

        /* RETTET: Kun hverdage vises - weekend styling fjernet */
        .weekday {
            background: #f8f9fa;
        }

        /* RETTET: I dag markering tilf√∏jet */
        .today-column {
            background-color: #e3f2fd !important;
            border: 2px solid #2196F3 !important;
        }
        
        .today-header {
            background-color: #2196F3 !important;
            color: white !important;
            font-weight: bold !important;
        }

        .task-item {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            margin: 2px;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 11px;
            cursor: grab;
            position: relative;
            word-wrap: break-word;
        }

        .task-item:active {
            cursor: grabbing;
        }

        .task-item.medium {
            background: linear-gradient(135deg, #ffa726, #fb8c00);
        }

        .task-item.low {
            background: linear-gradient(135deg, #66bb6a, #43a047);
        }

        .task-item.half-day {
            height: 30px;
        }

        .task-item.in-progress {
            border: 2px solid #2196f3;
        }

        .task-item.completed {
            opacity: 0.7;
            text-decoration: line-through;
        }

        /* RETTET: Tooltip styling tilf√∏jet */
        .task-tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            max-width: 250px;
            white-space: normal;
        }
        
        .task-tooltip::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid #333;
        }

        /* RETTET: Overlap h√•ndtering styling */
        .task-overlap {
            position: relative;
            z-index: 10;
            margin-top: -2px;
            opacity: 0.9;
        }
        
        .task-overlap::after {
            content: 'üìã';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            background: #ff9800;
            color: white;
            padding: 1px 3px;
            border-radius: 2px;
        }

        .drop-zone {
            background: rgba(33, 150, 243, 0.1);
            border: 2px dashed #2196f3;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal.open {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .undo-redo {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .undo-btn, .redo-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .undo-btn:disabled, .redo-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* RETTET: Toast styling tilf√∏jet */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .toast.error {
            background: #f44336;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .pdf-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .export-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }

            .timeline-grid {
                overflow-x: auto;
            }

            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
            }
        }

        /* No-print class for elements that shouldn't appear in PDF */
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">SWITZEA ApS</div>
            <div class="subtitle">ENHANCED H√ÖNDV√ÜRKER PDF | Timeline + Dag-for-dag + H√•ndv√¶rker sektioner</div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="craftsman-list">
                    <h3>H√•ndv√¶rkere</h3>
                    <button class="primary-btn" onclick="openCraftsmanModal()">+ Tilf√∏j</button>
                    <div id="craftsmanList">
                        <div class="empty-state">
                            <p>Ingen h√•ndv√¶rkere tilf√∏jet endnu</p>
                            <small>Tilf√∏j f√∏rste h√•ndv√¶rker</small>
                        </div>
                    </div>
                </div>

                <div class="undo-redo no-print">
                    <button id="undoBtn" class="undo-btn" onclick="undo()" disabled>‚Ü∂ Fortryd</button>
                    <button id="redoBtn" class="redo-btn" onclick="redo()" disabled>‚Ü∑ Gentag</button>
                </div>
            </div>

            <div class="content-area">
                <div class="timeline-controls">
                    <div class="week-controls">
                        <button class="week-btn" onclick="removeWeek()">‚àí Fjern uge</button>
                        <span id="weekDisplay">3 uger</span>
                        <button class="week-btn" onclick="addWeek()">+ Tilf√∏j uge</button>
                    </div>
                </div>

                <div class="project-info">
                    <h3 id="projectTitle">Projekt: Start dato mangler</h3>
                    <p id="timelineInfo">Start: <span id="projectStartDisplay">Tilf√∏j h√•ndv√¶rkere og s√¶t projektets startdato for at se tidslinjen</span></p>
                    
                    <!-- RETTET: Ny Opgave knap tilf√∏jet her -->
                    <div class="action-buttons no-print">
                        <button class="new-task-btn" onclick="openTaskModal()">
                            üìã Ny Opgave
                        </button>
                        <button class="primary-btn" onclick="editProject()">üìä Projekt Information</button>
                    </div>
                </div>

                <div class="pdf-buttons no-print">
                    <button class="export-btn" onclick="exportWorkerPDF()">üìÑ Export Worker PDF</button>
                    <button class="export-btn" onclick="exportCustomerPDF()">üìÑ Export Customer PDF</button>
                    <button class="primary-btn" onclick="saveProjectToStorage()">üíæ Gem Data</button>
                    <button class="secondary-btn" onclick="loadProjectFromStorage()">üìÇ Indl√¶s Data</button>
                </div>

                <div class="timeline-container">
                    <div id="timelineGrid" class="timeline-grid">
                        <!-- Timeline will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('projectModal')">&times;</button>
            <h3>Projekt Information</h3>
            <div class="form-group">
                <label for="projectName">Projekt Navn</label>
                <input type="text" id="projectName" placeholder="Indtast projekt navn">
            </div>
            <div class="form-group">
                <label for="customerName">Kunde Navn</label>
                <input type="text" id="customerName" placeholder="Indtast kunde navn">
            </div>
            <div class="form-group">
                <label for="projectAddress">Adresse</label>
                <input type="text" id="projectAddress" placeholder="Indtast projekt adresse">
            </div>
            <div class="form-group">
                <label for="customerPhone">Telefon</label>
                <input type="tel" id="customerPhone" placeholder="Indtast telefon nummer">
            </div>
            <div class="form-group">
                <label for="customerEmail">E-mail</label>
                <input type="email" id="customerEmail" placeholder="Indtast e-mail adresse">
            </div>
            <div class="form-group">
                <label for="projectStartDate">Projekt Start Dato</label>
                <input type="date" id="projectStartDate">
            </div>
            <div class="modal-buttons">
                <button class="secondary-btn" onclick="closeModal('projectModal')">Annull√©r</button>
                <!-- RETTET: Knap tekst √¶ndret til "Opret Projekt" -->
                <button class="primary-btn" onclick="saveProject()">Opret Projekt</button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('taskModal')">&times;</button>
            <h3 id="modalTitle">Ny opgave</h3>
            <div class="form-group">
                <label for="taskTitle">Opgavetitel</label>
                <input type="text" id="taskTitle" placeholder="Indtast opgave titel">
            </div>
            <div class="form-group">
                <label for="taskDescription">Beskrivelse</label>
                <textarea id="taskDescription" placeholder="Beskriv opgaven"></textarea>
            </div>
            <div class="form-group">
                <label for="taskStartDate">Startdato</label>
                <input type="date" id="taskStartDate">
            </div>
            <div class="form-group">
                <label for="taskDuration">Varighed (dage)</label>
                <input type="number" id="taskDuration" min="1" max="30" value="1">
            </div>
            <div class="form-group">
                <label for="taskNotes">Noter/Kommentarer</label>
                <textarea id="taskNotes" placeholder="Ekstra noter til opgaven"></textarea>
            </div>
            <div class="form-group">
                <label for="taskCraftsman">H√•ndv√¶rker</label>
                <select id="taskCraftsman">
                    <option value="">V√¶lg h√•ndv√¶rker...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskPriority">Prioritet</label>
                <select id="taskPriority">
                    <option value="low">Lav</option>
                    <option value="medium">Medium</option>
                    <option value="high">H√∏j</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskStatus">Status</label>
                <select id="taskStatus">
                    <option value="planned">Planlagt</option>
                    <option value="in-progress">I gang</option>
                    <option value="completed">Udf√∏rt</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="taskHalfDay"> Halv dag opgave
                </label>
            </div>
            <div class="modal-buttons">
                <button class="secondary-btn" onclick="deleteCurrentTask()" id="deleteTaskBtn" style="display: none;">Slet opgave</button>
                <button class="secondary-btn" onclick="closeModal('taskModal')">Annull√©r</button>
                <button class="primary-btn" onclick="saveTask()">Gem opgave</button>
            </div>
        </div>
    </div>

    <!-- Craftsman Modal -->
    <div id="craftsmanModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('craftsmanModal')">&times;</button>
            <h3>Tilf√∏j h√•ndv√¶rker</h3>
            <div class="form-group">
                <label for="craftsmanType">H√•ndv√¶rkertype</label>
                <select id="craftsmanType">
                    <option value="">V√¶lg type...</option>
                    <option value="Projektleder">Projektleder</option>
                    <option value="Byggeleder">Byggeleder</option>
                    <option value="Elektriker">Elektriker</option>
                    <option value="VVS-mont√∏r">VVS-mont√∏r</option>
                    <option value="Maler">Maler</option>
                    <option value="T√∏mrer">T√∏mrer</option>
                    <option value="Murer">Murer</option>
                    <option value="Gulvl√¶gger">Gulvl√¶gger</option>
                    <option value="Reng√∏ringsassistent">Reng√∏ringsassistent</option>
                    <option value="Specialister">Specialister</option>
                </select>
            </div>
            <div class="form-group">
                <label for="craftsmanColor">Farve</label>
                <input type="color" id="craftsmanColor" value="#3498db">
            </div>
            <div class="modal-buttons">
                <button class="secondary-btn" onclick="closeModal('craftsmanModal')">Annull√©r</button>
                <button class="primary-btn" onclick="saveCraftsman()">Tilf√∏j</button>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let appState = {
            project: {
                name: '',
                customerName: '',
                address: '',
                phone: '',
                email: '',
                startDate: '',
                weeks: 3
            },
            craftsmen: [],
            tasks: [],
            timeline: {
                startDate: null,
                weeks: 3
            }
        };

        let currentTaskIndex = -1;
        let undoStack = [];
        let redoStack = [];

        // RETTET: Dansk dato format funktion tilf√∏jet
        function formatDateDanish(date) {
            if (!date) return '';
            const d = new Date(date);
            const day = d.getDate().toString().padStart(2, '0');
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}-${year}`;
        }

        // Date helper functions
        function getProjectStartDate() {
            return appState.project.startDate ? new Date(appState.project.startDate) : null;
        }

        function calculateDayFromDate(startDate, targetDate) {
            const start = new Date(startDate);
            const target = new Date(targetDate);
            const diffTime = Math.abs(target - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function calculateDateFromDay(startDate, dayNumber) {
            const date = new Date(startDate);
            date.setDate(date.getDate() + dayNumber);
            return date;
        }

        function getWeekDateRange(startDate, weeks) {
            const start = new Date(startDate);
            const end = new Date(startDate);
            end.setDate(start.getDate() + (weeks * 7) - 1);
            return { start, end };
        }

        function formatDateForDisplay(date) {
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            return date.toLocaleDateString('da-DK', options);
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function formatFullDateDanish(date) {
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            return date.toLocaleDateString('da-DK', options);
        }

        function isToday(date) {
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        // RETTET: Weekend check kun for visning - timeline viser kun hverdage
        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // 0 = s√∏ndag, 6 = l√∏rdag
        }

        // State management
        function saveState() {
            undoStack.push(JSON.parse(JSON.stringify(appState)));
            if (undoStack.length > 20) {
                undoStack.shift();
            }
            redoStack = [];
            updateUndoRedoButtons();
        }

        function undo() {
            if (undoStack.length > 0) {
                redoStack.push(JSON.parse(JSON.stringify(appState)));
                appState = undoStack.pop();
                updateUndoRedoButtons();
                renderAll();
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                undoStack.push(JSON.parse(JSON.stringify(appState)));
                appState = redoStack.pop();
                updateUndoRedoButtons();
                renderAll();
            }
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = undoStack.length === 0;
            document.getElementById('redoBtn').disabled = redoStack.length === 0;
        }

        // Rendering functions
        function renderAll() {
            renderProjectInfo();
            renderCraftsmen();
            renderTimeline();
            renderTasks();
        }

        function renderProjectInfo() {
            const titleElement = document.getElementById('projectTitle');
            const startDisplay = document.getElementById('projectStartDisplay');
            
            if (appState.project.name && appState.project.startDate) {
                titleElement.textContent = `Projekt: ${appState.project.name}`;
                const startDate = new Date(appState.project.startDate);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + (appState.project.weeks * 7) - 1);
                
                // RETTET: Brug dansk dato format
                startDisplay.innerHTML = `Start: ${formatDateDanish(startDate)} - Slut: ${formatDateDanish(endDate)} (${appState.project.weeks} uger)`;
            } else if (appState.project.startDate) {
                titleElement.textContent = 'Projekt: Tilf√∏j projekt navn';
                startDisplay.innerHTML = `Start: ${formatDateDanish(new Date(appState.project.startDate))}`;
            } else {
                titleElement.textContent = 'Projekt: Start dato mangler';
                startDisplay.textContent = 'Tilf√∏j h√•ndv√¶rkere og s√¶t projektets startdato for at se tidslinjen';
            }
        }

        function renderCraftsmen() {
            const container = document.getElementById('craftsmanList');
            
            if (appState.craftsmen.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Ingen h√•ndv√¶rkere tilf√∏jet endnu</p>
                        <small>Tilf√∏j f√∏rste h√•ndv√¶rker</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = appState.craftsmen.map(craftsman => `
                <div class="craftsman-item" data-craftsman="${craftsman.type}" oncontextmenu="deleteCraftsman('${craftsman.type}'); return false;">
                    <div class="craftsman-color" style="background-color: ${craftsman.color}"></div>
                    <div class="craftsman-name">${craftsman.type}</div>
                </div>
            `).join('');
        }

        function renderTimeline() {
            const container = document.getElementById('timelineGrid');
            const startDate = getProjectStartDate();
            
            if (!startDate || appState.craftsmen.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Tilf√∏j h√•ndv√¶rkere og s√¶t projektets startdato for at se tidslinjen</p>
                    </div>
                `;
                return;
            }

            // RETTET: Generer kun hverdage (man-fre)
            const headers = ['H√•ndv√¶rker'];
            const currentDate = new Date(startDate);
            
            for (let week = 0; week < appState.project.weeks; week++) {
                for (let day = 0; day < 7; day++) {
                    // Spring weekender over
                    if (!isWeekend(currentDate)) {
                        const dateStr = formatDateForDisplay(currentDate);
                        headers.push(dateStr);
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }

            container.style.gridTemplateColumns = `200px repeat(${headers.length - 1}, 120px)`;
            
            let html = '';
            
            // Headers
            headers.forEach((header, index) => {
                const isToday = index > 0 && isDateToday(startDate, index - 1);
                const headerClass = index === 0 ? 'timeline-header' : (isToday ? 'timeline-header today-header' : 'timeline-header');
                html += `<div class="${headerClass}">${header}</div>`;
            });
            
            // Craftsman rows
            appState.craftsmen.forEach(craftsman => {
                html += `<div class="craftsman-row-header">
                    <div class="craftsman-color" style="background-color: ${craftsman.color}"></div>
                    ${craftsman.type}
                </div>`;
                
                for (let col = 1; col < headers.length; col++) {
                    const isToday = isDateToday(startDate, col - 1);
                    const cellClass = isToday ? 'timeline-cell today-column' : 'timeline-cell';
                    html += `<div class="${cellClass}" 
                                data-craftsman="${craftsman.type}" 
                                data-day="${col - 1}"
                                ondrop="drop(event)" 
                                ondragover="allowDrop(event)"
                                onclick="openTaskModal(${col - 1}, '${craftsman.type}')">
                            </div>`;
                }
            });
            
            container.innerHTML = html;
        }

        // RETTET: Hj√¶lpefunktion til at tjekke om dato er i dag
        function isDateToday(projectStartDate, dayOffset) {
            if (!projectStartDate || dayOffset < 0) return false;
            
            const targetDate = new Date(projectStartDate);
            let addedDays = 0;
            let currentDayOffset = 0;
            
            while (currentDayOffset < dayOffset) {
                targetDate.setDate(targetDate.getDate() + 1);
                if (!isWeekend(targetDate)) {
                    currentDayOffset++;
                }
            }
            
            const today = new Date();
            return targetDate.toDateString() === today.toDateString();
        }

        function renderTasks() {
            // Clear existing tasks
            document.querySelectorAll('.task-item').forEach(task => task.remove());
            
            const startDate = getProjectStartDate();
            if (!startDate) return;

            appState.tasks.forEach((task, index) => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.priority} ${task.status === 'in-progress' ? 'in-progress' : ''} ${task.status === 'completed' ? 'completed' : ''} ${task.halfDay ? 'half-day' : ''}`;
                
                // RETTET: Brug dansk dato format i task display
                taskElement.innerHTML = `
                    <div class="task-title">${task.title}</div>
                    <div class="task-date">${formatDateDanish(task.startDate)}</div>
                `;
                
                taskElement.draggable = true;
                taskElement.dataset.taskIndex = index;
                
                // RETTET: Tilf√∏j tooltip funktionalitet
                taskElement.addEventListener('mouseenter', (e) => showTaskTooltip(e, task));
                taskElement.addEventListener('mouseleave', hideTaskTooltip);
                
                taskElement.ondragstart = drag;
                taskElement.ondblclick = () => editTask(index);

                const taskDate = new Date(task.startDate);
                const dayNumber = calculateDayFromDate(startDate, taskDate);
                
                // Find den korrekte celle (kun hverdage)
                let weekdayCount = 0;
                let searchDate = new Date(startDate);
                let targetDay = -1;
                
                while (weekdayCount <= dayNumber) {
                    if (!isWeekend(searchDate)) {
                        if (weekdayCount === dayNumber) {
                            targetDay = weekdayCount;
                            break;
                        }
                        weekdayCount++;
                    }
                    searchDate.setDate(searchDate.getDate() + 1);
                }
                
                if (targetDay >= 0) {
                    const cell = document.querySelector(`[data-craftsman="${task.craftsman}"][data-day="${targetDay}"]`);
                    if (cell) {
                        // RETTET: Tjek for overlap og tilf√∏j styling
                        const existingTasks = cell.querySelectorAll('.task-item');
                        if (existingTasks.length > 0) {
                            taskElement.classList.add('task-overlap');
                        }
                        cell.appendChild(taskElement);
                    }
                }
            });
        }

        // RETTET: Tooltip funktioner implementeret
        let currentTooltip = null;

        function showTaskTooltip(event, task) {
            hideTaskTooltip(); // Fjern eksisterende tooltip
            
            const tooltip = document.createElement('div');
            tooltip.className = 'task-tooltip';
            tooltip.innerHTML = `
                <strong>${task.title}</strong><br>
                üìÖ ${formatDateDanish(task.startDate)} (${task.duration} dage)<br>
                üë∑ ${task.craftsman}<br>
                üî• ${task.priority} prioritet<br>
                üìä Status: ${task.status}<br>
                ${task.description ? `üìù ${task.description}` : ''}
                ${task.notes ? `<br>üí≠ ${task.notes}` : ''}
            `;
            
            document.body.appendChild(tooltip);
            currentTooltip = tooltip;
            
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
        }

        function hideTaskTooltip() {
            if (currentTooltip) {
                document.body.removeChild(currentTooltip);
                currentTooltip = null;
            }
        }

        // RETTET: Toast funktioner implementeret
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 4000);
        }

        // Modal functions
        function openTaskModal(day = null, craftsman = null) {
            // RETTET: Auto-scroll til top implementeret
            window.scrollTo(0, 0);
            
            document.getElementById('taskModal').classList.add('open');
            document.getElementById('modalTitle').textContent = 'Ny opgave';
            clearTaskFields();
            
            if (day !== null) {
                const startDate = getProjectStartDate();
                if (startDate) {
                    const taskDate = calculateDateFromDay(startDate, day);
                    document.getElementById('taskStartDate').value = formatDateForInput(taskDate);
                }
            }
            if (craftsman !== null) {
                document.getElementById('taskCraftsman').value = craftsman;
            }
            
            currentTaskIndex = -1;
            populateCraftsmanDropdown();
            document.getElementById('deleteTaskBtn').style.display = 'none';
        }

        function openCraftsmanModal() {
            document.getElementById('craftsmanModal').classList.add('open');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
        }

        function editProject() {
            document.getElementById('projectName').value = appState.project.name || '';
            document.getElementById('customerName').value = appState.project.customerName || '';
            document.getElementById('projectAddress').value = appState.project.address || '';
            document.getElementById('customerPhone').value = appState.project.phone || '';
            document.getElementById('customerEmail').value = appState.project.email || '';
            document.getElementById('projectStartDate').value = appState.project.startDate || '';
            document.getElementById('projectModal').classList.add('open');
        }

        function editTask(taskIndex) {
            // RETTET: Auto-scroll til top ved task edit
            window.scrollTo(0, 0);
            
            const task = appState.tasks[taskIndex];
            currentTaskIndex = taskIndex;
            
            document.getElementById('modalTitle').textContent = 'Rediger opgave';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskStartDate').value = task.startDate;
            document.getElementById('taskDuration').value = task.duration;
            document.getElementById('taskNotes').value = task.notes || '';
            document.getElementById('taskCraftsman').value = task.craftsman;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskStatus').value = task.status;
            document.getElementById('taskHalfDay').checked = task.halfDay || false;
            
            populateCraftsmanDropdown();
            document.getElementById('deleteTaskBtn').style.display = 'block';
            document.getElementById('taskModal').classList.add('open');
        }

        function createTask() {
            openTaskModal();
        }

        function clearTaskFields() {
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskStartDate').value = '';
            document.getElementById('taskDuration').value = '1';
            document.getElementById('taskNotes').value = '';
            document.getElementById('taskCraftsman').value = '';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskStatus').value = 'planned';
            document.getElementById('taskHalfDay').checked = false;
        }

        // Save functions
        function saveProject() {
            saveState();
            
            appState.project.name = document.getElementById('projectName').value;
            appState.project.customerName = document.getElementById('customerName').value;
            appState.project.address = document.getElementById('projectAddress').value;
            appState.project.phone = document.getElementById('customerPhone').value;
            appState.project.email = document.getElementById('customerEmail').value;
            appState.project.startDate = document.getElementById('projectStartDate').value;
            
            closeModal('projectModal');
            renderAll();
            showToast('Projekt information gemt');
        }

        // RETTET: saveTask med h√•ndv√¶rker validering
        function saveTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const craftsman = document.getElementById('taskCraftsman').value;
            const startDate = document.getElementById('taskStartDate').value;
            
            // RETTET: Validering - h√•ndv√¶rker skal v√¶re valgt
            if (!craftsman || craftsman === '') {
                showToast('V√¶lg venligst en h√•ndv√¶rker f√∏r opgaven gemmes', 'error');
                return;
            }
            
            // RETTET: Validering - titel skal v√¶re udfyldt
            if (!title) {
                showToast('Indtast venligst en opgavetitel', 'error');
                return;
            }

            // RETTET: Validering - startdato skal v√¶re valgt
            if (!startDate) {
                showToast('V√¶lg venligst en startdato', 'error');
                return;
            }
            
            saveState();
            
            const task = {
                title: title,
                description: document.getElementById('taskDescription').value,
                startDate: startDate,
                duration: parseInt(document.getElementById('taskDuration').value),
                notes: document.getElementById('taskNotes').value,
                craftsman: craftsman,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                halfDay: document.getElementById('taskHalfDay').checked
            };
            
            if (currentTaskIndex >= 0) {
                appState.tasks[currentTaskIndex] = task;
                showToast('Opgave opdateret');
            } else {
                appState.tasks.push(task);
                showToast('Opgave oprettet');
            }
            
            closeModal('taskModal');
            renderAll();
        }

        function saveCraftsman() {
            const type = document.getElementById('craftsmanType').value;
            const color = document.getElementById('craftsmanColor').value;
            
            if (!type) {
                showToast('V√¶lg venligst en h√•ndv√¶rkertype', 'error');
                return;
            }
            
            saveState();
            
            appState.craftsmen.push({
                type: type,
                color: color
            });
            
            closeModal('craftsmanModal');
            renderAll();
            showToast('H√•ndv√¶rker tilf√∏jet');
        }

        function deleteCurrentTask() {
            if (currentTaskIndex >= 0 && confirm('Er du sikker p√• at du vil slette denne opgave?')) {
                saveState();
                appState.tasks.splice(currentTaskIndex, 1);
                closeModal('taskModal');
                renderAll();
                showToast('Opgave slettet');
            }
        }

        function deleteTask(taskIndex) {
            if (confirm('Er du sikker p√• at du vil slette denne opgave?')) {
                saveState();
                appState.tasks.splice(taskIndex, 1);
                renderAll();
                showToast('Opgave slettet');
            }
        }

        function deleteCraftsman(type) {
            if (confirm(`Er du sikker p√• at du vil slette h√•ndv√¶rkeren "${type}"?`)) {
                saveState();
                appState.craftsmen = appState.craftsmen.filter(c => c.type !== type);
                appState.tasks = appState.tasks.filter(t => t.craftsman !== type);
                renderAll();
                showToast('H√•ndv√¶rker slettet');
            }
        }

        function populateCraftsmanDropdown() {
            const dropdown = document.getElementById('taskCraftsman');
            dropdown.innerHTML = '<option value="">V√¶lg h√•ndv√¶rker...</option>';
            
            appState.craftsmen.forEach(craftsman => {
                const option = document.createElement('option');
                option.value = craftsman.type;
                option.textContent = craftsman.type;
                dropdown.appendChild(option);
            });
        }

        // Timeline controls
        function addWeek() {
            saveState();
            appState.project.weeks++;
            document.getElementById('weekDisplay').textContent = `${appState.project.weeks} uger`;
            renderAll();
        }

        function removeWeek() {
            if (appState.project.weeks > 1) {
                saveState();
                appState.project.weeks--;
                document.getElementById('weekDisplay').textContent = `${appState.project.weeks} uger`;
                renderAll();
            }
        }

        // Drag and drop
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drop-zone');
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.dataset.taskIndex);
        }

        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drop-zone');
            
            const taskIndex = ev.dataTransfer.getData("text");
            const craftsman = ev.currentTarget.dataset.craftsman;
            const day = parseInt(ev.currentTarget.dataset.day);
            
            if (taskIndex !== "" && craftsman && day >= 0) {
                saveState();
                
                const startDate = getProjectStartDate();
                const newDate = calculateDateFromDay(startDate, day);
                
                appState.tasks[taskIndex].craftsman = craftsman;
                appState.tasks[taskIndex].startDate = formatDateForInput(newDate);
                
                renderAll();
                showToast('Opgave flyttet');
            }
        }

        // Storage functions
        function saveProjectToStorage() {
            localStorage.setItem('switzea_project', JSON.stringify(appState));
            showToast('Projekt data gemt lokalt');
        }

        function loadProjectFromStorage() {
            const saved = localStorage.getItem('switzea_project');
            if (saved) {
                appState = JSON.parse(saved);
                renderAll();
                showToast('Projekt data indl√¶st');
            } else {
                showToast('Ingen gemt data fundet', 'error');
            }
        }

        // RETTET: PDF funktioner med korrekt dato h√•ndtering
        function generateWorkerSchedule() {
            if (!appState.project.startDate) {
                return '<p>Indstil projektets startdato f√∏rst</p>';
            }
            
            let scheduleHTML = '<h3>üìÖ Uge-for-uge Plan</h3>';
            const startDate = new Date(appState.project.startDate);
            
            // Generer kun hverdage
            for (let week = 0; week < appState.project.weeks; week++) {
                scheduleHTML += `<h4>Uge ${week + 1}</h4>`;
                
                let weekHasTasks = false;
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + (week * 7));
                
                for (let day = 0; day < 7; day++) {
                    const dayDate = new Date(currentDate);
                    dayDate.setDate(currentDate.getDate() + day);
                    
                    // Spring weekender over
                    if (isWeekend(dayDate)) {
                        continue;
                    }
                    
                    const dateStr = formatDateDanish(dayDate);
                    const dayTasks = appState.tasks.filter(task => {
                        const taskDate = new Date(task.startDate);
                        return taskDate.toDateString() === dayDate.toDateString();
                    });
                    
                    if (dayTasks.length > 0) {
                        scheduleHTML += `<p><strong>${dateStr}:</strong></p><ul>`;
                        dayTasks.forEach(task => {
                            scheduleHTML += `<li>${task.craftsman}: ${task.title} (${task.priority} prioritet)</li>`;
                        });
                        scheduleHTML += '</ul>';
                        weekHasTasks = true;
                    }
                }
                
                if (!weekHasTasks) {
                    scheduleHTML += '<p><em>Ingen opgaver planlagt denne uge</em></p>';
                }
            }
            return scheduleHTML;
        }

        function generateCraftsmanSections() {
            let sectionsHTML = '<h3>üë∑ H√•ndv√¶rker Oversigt</h3>';
            
            appState.craftsmen.forEach(craftsman => {
                sectionsHTML += `<h4>${craftsman.type}</h4>`;
                
                const craftsmanTasks = appState.tasks.filter(task => task.craftsman === craftsman.type);
                
                if (craftsmanTasks.length > 0) {
                    sectionsHTML += '<ul>';
                    craftsmanTasks.forEach(task => {
                        sectionsHTML += `<li><strong>${task.title}</strong> - ${formatDateDanish(task.startDate)} (${task.duration} dage) - ${task.priority} prioritet</li>`;
                    });
                    sectionsHTML += '</ul>';
                } else {
                    sectionsHTML += '<p><em>Ingen opgaver tildelt</em></p>';
                }
            });
            
            return sectionsHTML;
        }

        // RETTET: exportWorkerPDF med korrekte datoer
        function exportWorkerPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(44, 90, 160);
            doc.text('SWITZEA ApS - H√•ndv√¶rker Rapport', 20, 30);
            
            // Projekt info
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            let yPos = 50;
            
            if (appState.project.name) {
                doc.text(`Projekt: ${appState.project.name}`, 20, yPos);
                yPos += 10;
            }
            
            if (appState.project.startDate) {
                const startDate = new Date(appState.project.startDate);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + (appState.project.weeks * 7) - 1);
                
                doc.text(`Periode: ${formatDateDanish(startDate)} - ${formatDateDanish(endDate)}`, 20, yPos);
                yPos += 20;
            }
            
            // Timeline oversigt
            doc.setFontSize(14);
            doc.text('Timeline Oversigt', 20, yPos);
            yPos += 10;
            
            // RETTET: Korrekt task count
            const totalTasks = appState.tasks.length;
            doc.setFontSize(10);
            doc.text(`Total opgaver: ${totalTasks}`, 20, yPos);
            yPos += 15;
            
            // Opgave detaljer med korrekte datoer
            appState.tasks.forEach((task, index) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 30;
                }
                
                doc.text(`${index + 1}. ${task.title}`, 20, yPos);
                yPos += 7;
                doc.text(`   H√•ndv√¶rker: ${task.craftsman}`, 25, yPos);
                yPos += 7;
                doc.text(`   Dato: ${formatDateDanish(task.startDate)} (${task.duration} dage)`, 25, yPos);
                yPos += 7;
                doc.text(`   Prioritet: ${task.priority} | Status: ${task.status}`, 25, yPos);
                yPos += 10;
            });
            
            doc.save(`switzea-haandvaerker-rapport-${formatDateDanish(new Date()).replace(/\//g, '-')}.pdf`);
            showToast('H√•ndv√¶rker PDF eksporteret');
        }

        // RETTET: exportCustomerPDF med korrekt data
        function exportCustomerPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(44, 90, 160);
            doc.text('SWITZEA ApS - Kunde Status Rapport', 20, 30);
            
            let yPos = 50;
            
            // Kunde information
            if (appState.project.customerName) {
                doc.setFontSize(14);
                doc.text(`Kunde: ${appState.project.customerName}`, 20, yPos);
                yPos += 15;
            }
            
            if (appState.project.name) {
                doc.setFontSize(12);
                doc.text(`Projekt: ${appState.project.name}`, 20, yPos);
                yPos += 10;
            }
            
            if (appState.project.address) {
                doc.text(`Adresse: ${appState.project.address}`, 20, yPos);
                yPos += 15;
            }
            
            // Projekt status
            doc.setFontSize(14);
            doc.text('Projekt Status', 20, yPos);
            yPos += 10;
            
            if (appState.project.startDate) {
                const startDate = new Date(appState.project.startDate);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + (appState.project.weeks * 7) - 1);
                
                doc.setFontSize(10);
                doc.text(`Projektperiode: ${formatDateDanish(startDate)} - ${formatDateDanish(endDate)}`, 20, yPos);
                yPos += 10;
                
                // RETTET: Korrekt task counting
                const totalTasks = appState.tasks.length;
                const completedTasks = appState.tasks.filter(task => task.status === 'completed').length;
                const inProgressTasks = appState.tasks.filter(task => task.status === 'in-progress').length;
                const plannedTasks = appState.tasks.filter(task => task.status === 'planned').length;
                
                doc.text(`Total opgaver: ${totalTasks}`, 20, yPos);
                yPos += 7;
                doc.text(`F√¶rdige: ${completedTasks} | I gang: ${inProgressTasks} | Planlagt: ${plannedTasks}`, 20, yPos);
                yPos += 15;
                
                // Fremgang
                const progressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                doc.text(`Fremgang: ${progressPercent}%`, 20, yPos);
                yPos += 15;
            }
            
            // H√•ndv√¶rker oversigt
            doc.setFontSize(14);
            doc.text('H√•ndv√¶rker Team', 20, yPos);
            yPos += 10;
            
            appState.craftsmen.forEach(craftsman => {
                const craftsmanTasks = appState.tasks.filter(task => task.craftsman === craftsman.type);
                doc.setFontSize(10);
                doc.text(`‚Ä¢ ${craftsman.type}: ${craftsmanTasks.length} opgaver`, 20, yPos);
                yPos += 7;
            });
            
            yPos += 10;
            
            // Kommende opgaver
            doc.setFontSize(14);
            doc.text('N√¶ste Opgaver', 20, yPos);
            yPos += 10;
            
            const upcomingTasks = appState.tasks
                .filter(task => task.status !== 'completed')
                .sort((a, b) => new Date(a.startDate) - new Date(b.startDate))
                .slice(0, 5);
                
            upcomingTasks.forEach(task => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 30;
                }
                
                doc.setFontSize(10);
                doc.text(`‚Ä¢ ${task.title} - ${formatDateDanish(task.startDate)} (${task.craftsman})`, 20, yPos);
                yPos += 7;
            });
            
            // Footer
            doc.setFontSize(8);
            doc.text(`Rapport genereret: ${formatDateDanish(new Date())}`, 20, 280);
            doc.text('SWITZEA ApS | Professionel h√•ndv√¶rker koordinering', 20, 290);
            
            doc.save(`switzea-kunde-rapport-${formatDateDanish(new Date()).replace(/\//g, '-')}.pdf`);
            showToast('Kunde PDF eksporteret');
        }

        // Remove drag over effect when leaving
        document.addEventListener('dragleave', (e) => {
            if (e.target.classList.contains('timeline-cell')) {
                e.target.classList.remove('drop-zone');
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('open');
            }
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            renderAll();
            updateUndoRedoButtons();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) {
                            redo();
                        } else {
                            undo();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        saveProjectToStorage();
                        break;
                }
            }
        });
    </script>
</body>
</html>
